<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Девичник — детектив</title>
<style>
/* Текст сцены "Тропинка к собору" */
#cathedralText p,
#cathedralText .scene-line {
  font-family: 'Manrope', 'Segoe UI', sans-serif !important;
  font-size: 17px;
  line-height: 1.7;
  color: #eef2f8;
  text-shadow: none !important;
  margin: 0 0 12px;
}
@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap');

:root{
  /* ===== ПАЛИТРА ===== */
  --bg-image: url("detective-bg.png"); /* <-- замени на свой путь */
  --bg-1: #060a12;
  --bg-2: #0b1220;
  --panel: rgba(255,255,255,0.04);
  --panel-border: rgba(255,255,255,0.10);
  --text-main: #eef2f8;
  --text-soft: #b8c0d0;
  --accent: #4b8dff;
  --accent-2: #2d6fe6;
  --accent-glow: rgba(75,141,255,0.35);
  --danger-glow: rgba(255, 80, 80, 0.18);
}

/* ===== БАЗА ===== */
* { box-sizing: border-box; }

html, body {
  min-height: 100%;
}

body {
  margin: 0;
  padding: 32px 20px 40px;
  color: var(--text-main);
  font-family: 'Manrope', 'Segoe UI', sans-serif;
  font-size: 18px;
  line-height: 1.6;

  /* Более мягкий фон: картинка заметнее */
  background:
    radial-gradient(circle at 18% 22%, rgba(75,141,255,0.05) 0%, rgba(75,141,255,0.00) 42%),
    linear-gradient(120deg, rgba(6,10,18,0.50) 0%, rgba(6,10,18,0.35) 42%, rgba(6,10,18,0.25) 100%),
    var(--bg-image) center center / cover no-repeat fixed,
    linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
}
/* Контейнер игры */
#game{
  max-width: 1100px;
  margin: 0 auto;
  position: relative;
}

/* Заголовки */
#game h1,
#game h2,
#game h3 {
  font-family: 'Oswald', sans-serif;
  letter-spacing: 0.6px;
  line-height: 1.1;
  margin-top: 0;
  color: #f7f9ff;
  text-transform: uppercase;
}

#game h1 {
  font-size: clamp(32px, 6vw, 68px);
  font-weight: 700;
  text-align: center;
  margin-bottom: 18px;
  text-shadow:
    0 0 18px rgba(75,141,255,0.16),
    0 0 38px rgba(75,141,255,0.10);
}

#game h2 {
  font-size: clamp(24px, 3vw, 36px);
  font-weight: 600;
  margin-bottom: 14px;
}

#game h3 {
  font-size: 22px;
  font-weight: 500;
  margin-bottom: 10px;
}

/* Обычный текст */
#sceneText p,
#game p {
  color: var(--text-main);
  line-height: 1.7;
  font-size: 17px;
  margin: 0 0 12px;
  text-shadow: none;
}

/* Вторичный текст */
#game small,
#game .muted {
  color: var(--text-soft);
}

/* Ссылки */
a {
  color: #86b3ff;
}
a:hover {
  color: #b4d0ff;
}

/* ===== ИЗОБРАЖЕНИЕ ВСТУПЛЕНИЯ ===== */
#introImage {
  display: block;
  margin: 0 auto 22px auto;
  width: min(100%, 760px);
  max-width: 760px;
  height: auto;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow:
    0 10px 28px rgba(0,0,0,0.35),
    0 0 0 1px rgba(255,255,255,0.03) inset;
}

/* ===== КНОПКИ ===== */
button {
  appearance: none;
  background: linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.12);
  padding: 12px 18px;
  margin-top: 12px;
  border-radius: 10px;
  cursor: pointer;
  font-family: 'Manrope', sans-serif;
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.2px;
  transition: transform 0.15s ease, box-shadow 0.18s ease, filter 0.18s ease, background 0.18s ease;
  box-shadow:
    0 6px 16px rgba(0,0,0,0.25),
    0 0 0 0 rgba(75,141,255,0.00);
}

button:hover {
  transform: translateY(-1px);
  filter: brightness(1.06);
  box-shadow:
    0 8px 20px rgba(0,0,0,0.32),
    0 0 0 6px rgba(75,141,255,0.10),
    0 0 20px var(--accent-glow);
}

button:active {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.55;
  cursor: not-allowed;
  filter: grayscale(0.15);
  box-shadow: none;
}

/* Если где-то захочешь вторичные кнопки — просто добавь class="secondary" */
button.secondary {
  background: rgba(255,255,255,0.03);
  color: var(--text-main);
  border: 1px solid rgba(255,255,255,0.16);
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}
button.secondary:hover {
  background: rgba(255,255,255,0.06);
  box-shadow:
    0 8px 18px rgba(0,0,0,0.22),
    0 0 0 4px rgba(255,255,255,0.05);
}

/* ===== POLICE CORRIDOR (flashlight) ===== */
.corridor-wrap{
  position: relative;
  max-width: 1100px;
  width: 100%;
  margin: 14px auto 0 auto;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 12px 30px rgba(0,0,0,0.28);
}

.corridor-wrap img{
  width: 100%;
  height: auto;
  display: block;
}

/* затемнение + фонарик */
.flashlight-overlay{
  position:absolute;
  inset:0;
  pointer-events:none;
  background: radial-gradient(
    circle 120px at var(--fx, 50%) var(--fy, 45%),
    rgba(0,0,0,0.0) 0%,
    rgba(0,0,0,0.18) 35%,
    rgba(0,0,0,0.88) 72%,
    rgba(0,0,0,0.96) 100%
  );
  transition: background 0.03s linear;
}

/* “дверь” как hotspot */
.door-spot{
  position:absolute;
  cursor:pointer;
}

/* маленькая табличка появляется только при наведении */
.door-spot .door-tag{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%) scale(0.98);
  padding: 8px 12px;
  border-radius: 10px;
  background: rgba(9, 12, 20, 0.86);
  border: 1px solid rgba(255,255,255,0.16);
  color: #f6f8ff;
  font-family: 'Oswald', sans-serif;
  font-size: 14px;
  letter-spacing: 0.6px;
  white-space: nowrap;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28);

  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: 0.15s ease;
}

.door-spot:hover .door-tag{
  opacity:1;
  visibility:visible;
  transform: translate(-50%, -50%) scale(1);
}

/* ===== Park Hotspots: кнопки видны только при наведении ===== */
.hotspot{
  position: absolute !important;
  z-index: 10 !important;
  cursor: pointer !important;
}

.hotspot-button{
  position: absolute !important;
  left: 50% !important;
  top: 50% !important;
  transform: translate(-50%, -50%) scale(0.98) !important;

  background: rgba(9, 12, 20, 0.88) !important;
  color: #fff !important;
  padding: 10px 16px !important;
  border-radius: 10px !important;
  border: 1px solid rgba(255,255,255,0.16) !important;
  font-family: 'Oswald', sans-serif !important;
  font-size: 14px !important;
  letter-spacing: 0.5px !important;
  line-height: 1 !important;
  box-shadow: 0 8px 18px rgba(0,0,0,0.28) !important;

  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
  transition: 0.18s ease !important;
}

.hotspot:hover .hotspot-button{
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
  transform: translate(-50%, -50%) scale(1) !important;
}

/* Небольшой скроллбар (если длинные сцены) */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.14);
  border-radius: 12px;
}
::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.22);
}
/* ===== ГЛОБАЛЬНЫЙ БЛОКНОТ ===== */
:root{
  --notebook-image: url("bloknot.png"); /* <-- здесь потом поставишь свою картинку */
}

/* Кнопка открытия блокнота (всегда поверх игры) */
#notebookToggleBtn {
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 9998;

  padding: 12px 16px !important;
  border-radius: 12px !important;
  border: 1px solid rgba(255,255,255,0.14) !important;
  background: rgba(12, 16, 26, 0.88) !important;
  color: #f4f7ff !important;
  font-family: 'Manrope', 'Segoe UI', sans-serif !important;
  font-size: 14px !important;
  font-weight: 700 !important;
  letter-spacing: 0.2px !important;
  cursor: pointer;
  box-shadow: 0 10px 24px rgba(0,0,0,0.35);
  backdrop-filter: blur(4px);
  transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
}

#notebookToggleBtn:hover {
  transform: translateY(-1px);
  background: rgba(18, 24, 38, 0.95) !important;
  box-shadow: 0 12px 26px rgba(0,0,0,0.42);
}

/* Обёртка блока */
#notebookWidget {
  position: fixed;
  right: 18px;
  bottom: 72px;
  width: min(430px, calc(100vw - 24px));
  z-index: 9999;
  pointer-events: none;
}

/* Панель блокнота (складная) */
#notebookPanel {
  pointer-events: auto;
  opacity: 0;
  visibility: hidden;
  transform: translateY(14px) scale(0.97);
  transform-origin: right bottom;
  transition: opacity 0.18s ease, transform 0.18s ease, visibility 0.18s ease;

  border-radius: 16px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(8, 10, 16, 0.86);
  box-shadow: 0 18px 48px rgba(0,0,0,0.5);
  backdrop-filter: blur(6px);
}

#notebookWidget.open #notebookPanel {
  opacity: 1;
  visibility: visible;
  transform: translateY(0) scale(1);
}

/* Шапка блокнота */
.notebook-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}

.notebook-title {
  color: #eef2f8;
  font-family: 'Oswald', sans-serif;
  font-size: 17px;
  letter-spacing: 0.6px;
  text-transform: uppercase;
}

.notebook-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.notebook-mini-btn {
  padding: 6px 10px !important;
  margin-top: 0 !important;
  border-radius: 8px !important;
  font-size: 12px !important;
  font-weight: 700 !important;
  background: rgba(255,255,255,0.04) !important;
  border: 1px solid rgba(255,255,255,0.10) !important;
  color: #eef2f8 !important;
  box-shadow: none !important;
}
.notebook-mini-btn:hover {
  background: rgba(255,255,255,0.08) !important;
  transform: none !important;
  box-shadow: none !important;
}

/* "Лист" блокнота с твоей картинкой */
.notebook-paper {
  position: relative;
  padding: 14px;
  background:
    linear-gradient(rgba(255,255,255,0.05), rgba(255,255,255,0.05)),
    var(--notebook-image) center center / cover no-repeat;
}

/* затемнение/осветление поверх картинки (можешь регулировать) */
.notebook-paper::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.08); /* если твоя картинка тёмная — увеличь до 0.12-0.18 */
  pointer-events: none;
}

.notebook-inner {
  position: relative;
  z-index: 1;
}

/* Поле заметок */
#notebookText {
  width: 100%;
  min-height: 280px;
  max-height: 52vh;
  resize: vertical;

  border-radius: 10px;
  border: 1px solid rgba(20, 24, 34, 0.14);
  outline: none;

  padding: 12px 14px;
  background: rgba(255,255,255,0.58); /* если хочешь больше видеть картинку — поставь 0.38-0.45 */
  color: #1b2230;

  font-family: 'Manrope', 'Segoe UI', sans-serif;
  font-size: 15px;
  line-height: 1.55;

  box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
}

#notebookText:focus {
  border-color: rgba(75,141,255,0.35);
  box-shadow: 0 0 0 3px rgba(75,141,255,0.10), inset 0 1px 2px rgba(0,0,0,0.06);
}

.notebook-footer {
  margin-top: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  color: #2b3445;
  font-size: 12px;
  opacity: 0.9;
}

#notebookStatus {
  color: #2b3445;
}

#notebookCount {
  color: #4b5568;
}

/* На очень узких экранах */
@media (max-width: 560px) {
  #notebookWidget {
    right: 10px;
    bottom: 64px;
    width: calc(100vw - 20px);
  }

  #notebookToggleBtn {
    right: 10px;
    bottom: 10px;
    font-size: 13px !important;
    padding: 10px 12px !important;
  }

  #notebookText {
    min-height: 220px;
  }
}
</style>
</head>
<body>

<div id="game"></div>

<audio id="bgMusic" src="song-fon.mp3" loop preload="auto"></audio>
<audio id="iphoneRing" src="zvuk-iphone.mp3" preload="auto"></audio>

<script>
const POLICE = {
  lockUntil: 0,
  lastChoice: ""
};

const PARK = {
  inspectedBin: false
};
const game = document.getElementById("game"); // контейнер для игры
let visitedCathedral = false; let lenaOpened = false; // открывали ли телефон Лены
const AUDIO_STATE = {
  bgStarted: false,
  unlocked: false
};

function getBgMusic() {
  return document.getElementById("bgMusic");
}

function getIphoneRing() {
  return document.getElementById("iphoneRing");
}

function setupAudioLevels() {
  const bg = getBgMusic();
  const ring = getIphoneRing();

  if (bg) bg.volume = 0.18;     // фон тихий
  if (ring) ring.volume = 0.65; // звонок громче
}

// Запуск фоновой музыки после первого клика (браузеры требуют действие пользователя)
async function startBgMusicIfNeeded() {
  const bg = getBgMusic();
  if (!bg) return;

  setupAudioLevels();

  try {
    AUDIO_STATE.unlocked = true;

    if (!AUDIO_STATE.bgStarted) {
      bg.currentTime = 0;
      await bg.play();
      AUDIO_STATE.bgStarted = true;
    } else if (bg.paused) {
      await bg.play();
    }
  } catch (e) {
    console.warn("Не удалось запустить фоновую музыку:", e);
  }
}

function pauseBgMusic() {
  const bg = getBgMusic();
  if (!bg) return;
  bg.pause();
}

async function resumeBgMusic() {
  const bg = getBgMusic();
  if (!bg) return;

  try {
    await bg.play();
    AUDIO_STATE.bgStarted = true;
  } catch (e) {
    console.warn("Не удалось возобновить фоновую музыку:", e);
  }
}

// Пауза фона -> звонок -> после окончания звонка снова фон
async function playIphoneRingThenResumeBg() {
  const ring = getIphoneRing();
  if (!ring) return;

  setupAudioLevels();

  pauseBgMusic();

  // Сбрасываем старые обработчики
  ring.onended = null;

  // Когда звонок закончится — вернуть фон
  ring.onended = () => {
    resumeBgMusic();
  };

  try {
    ring.currentTime = 0;
    await ring.play();
  } catch (e) {
    console.warn("Не удалось проиграть звонок:", e);
    // Если звонок не стартовал — вернём фон
    resumeBgMusic();
  }
}


// -------------------- Интро --------------------
function showRulesScreen() {
  game.innerHTML = `
    <h1>Правила игры</h1>

    <div style="
      max-width: 900px;
      margin: 0 auto;
      padding: 18px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    ">
      <p style="opacity:0.95;">
        Добро пожаловать в детективный квест <strong>«Девичник. Ночь, которую никто не помнит»</strong>.
      </p>

      <p style="margin-top:10px; opacity:0.9;">
        Ваша задача — восстановить события ночи и понять, что произошло с Витой.
      </p>

      <div style="margin-top:14px;">
        <p><strong>Как играть:</strong></p>
        <ul style="line-height:1.7; opacity:0.9; padding-left:20px;">
          <li>Читайте сцены внимательно — в тексте могут быть важные детали.</li>
          <li>Обсуждайте варианты и выбирайте действия вместе.</li>
          <li>Некоторые решения влияют на ход расследования.</li>
          <li>На отдельных этапах нужно вводить ответы вручную.</li>
          <li>Пользуйтесь блокнотом в игре, чтобы записывать улики и догадки, они вам позже пригодятся.</li>

        </ul>
      </div>

      <div style="margin-top:14px;">
        <p><strong>Важно:</strong></p>
        <ul style="line-height:1.7; opacity:0.9; padding-left:20px;">
          <li>Не обновляйте страницу, тк в данном случае прогресс потеряется и придется начинать заново!</li>
          <li>Если есть таймер — сначала спокойно прочитайте задание, потом отвечайте.</li>
          <li>Если играете повторно, в конце можно очистить заметки.</li>
        </ul>
      </div>

      <p style="margin-top:14px; opacity:0.85;">
        Готовы начать расследование? Удачи!
      </p>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="intro()">Перейти ко вступлению</button>
    </div>
  `;
}
function intro() {
    game.innerHTML = `
         <h1>ДЕВИЧНИК. НОЧЬ, КОТОРУЮ НИКТО НЕ ПОМНИТ</h1>
        <img id="introImage" src="unnamed.jpg" alt="Девичник">
        <div id="sceneText">
            <p>Около 18:00 они встретились в ресторане.
Как обычно — раз в несколько месяцев. Работа, мужья, дела — выбраться вместе получалось редко. Но сегодня повод был особенный. Катя выходит замуж! Они обнимаются, фотографируются, заказывают вино. Все искренне рады за неё, вино, тосты, разговоры, кажется, дальше танцы.. и вот уже днем следующего дня вы открываете глаза от яркого дневного света.
Холодно. Сыро. Трава колется сквозь тонкую ткань платья.
Перед вами — озеро.Чуть поодаль — величественный собор.
Вокруг — тишина. Вы отмечали девичник Кати. Смеялись. Пили. Выиграли какой-то конкурс. Было весело. А дальше — обрывки. Сейчас вас четверо. Но вас должно быть пятеро. Виты нет. Телефоны полностью разряжены.
<p>Праздничные наряды испачканы землёй. Вы не помните, где Вита.
<p>Вы не помните, что именно произошло этой ночью. И теперь вам нужно восстановить события.
Пока не стало слишком поздно.
<p>Главные вопросы игроков
<p>1.	Где Вита?
<p>2.	Как вы оказались у озера?
<p>3.	Что на самом деле произошло ночью?</p>
        </div>
        <button onclick="startGame()">Начать игру</button>
    `;
}

// -------------------- Начало игры --------------------
function startGame() {
    game.innerHTML = `
        <h2>Озеро. Утро.</h2>
        <p>Холодный воздух. Озеро почти неподвижное. Телефоны не включаются.</p>
        <h3>Что вы делаете?</h3>
        <button onclick="checkBags()">Проверить сумочки</button>
        <button onclick="goToCathedral()">Пойти к собору</button>
    `;
}

// -------------------- Сумочки --------------------
function checkBags() {
    game.innerHTML = `
        <h2>Сумочки</h2>
        <p>В сумочках найдены полностью разряженные телефоны, записка с номером телефона с подписью - закрутой Марк 555-0123, их банковские карты, помады. Также в сумочке Насти найден телефон Виты, разряженный.</p>
        <button onclick="startGame()">Вернуться к другому действию</button>
    `;
}

// -------------------- Сцена собора с анимацией --------------------
function goToCathedral() {
    const textLines = [
        "Вы идёте к зданию. Девушки оглядываются вокруг — дорожка, деревья, вода и вдалеке силуэт собора.",
        "— Пойдём туда. Там хотя бы люди могут быть.",
        "Они медленно идут по тропинке. Подходя ближе, они видят пожилую женщину с авоськой и платком на голове...",
        "— Простите… скажите, пожалуйста… где мы?",
        "Старушка щурится, осматривает их с головы до ног — платья в земле, растрёпанные волосы.",
        "— У Приоратского дворца вы. Гатчина.",
        "Тишина. Девушки переглядываются.",
        "— В смысле… Гатчина?",
        "— Ну да. Ленинградская область.",
        "Одна из них тихо выдыхает:",
        "— Мы вообще в Питере должны были быть…",
        "Невеста сжимает фату в руках.",
        "— А как нам до Санкт‑Петербурга добраться? И не знаете, где можно зарядить телефоны?",
        "Старушка спокойно отвечает:",
        "— Из парка выйдете — там кафе есть. Телефоны зарядите. Автобус ходит. Или такси вызовете.",
        "Пауза.",
        "— Спасибо…",
        "Старушка уходит по дорожке. Девушки остаются стоять в неловкой тишине.",
        "— Нам надо понять, что вообще произошло.",
        "— И где Вита."
    ];

    game.innerHTML = `
        <h2>Тропинка к собору</h2>
        <div id="cathedralText"></div>
        <div id="cathedralButtons" style="margin-top:15px;"></div>
    `;

    const textContainer = document.getElementById("cathedralText");
    const buttonsContainer = document.getElementById("cathedralButtons");

    if (visitedCathedral) {
        textLines.forEach(line => {
            const p = document.createElement("p");
            p.textContent = line;
            textContainer.appendChild(p);
        });
        buttonsContainer.innerHTML = `
            <button onclick="findCafe()">Сразу искать кафе</button>
            <button onclick="searchPark()">Обойти парк в поисках улик</button>
        `;
        return;
    }

    visitedCathedral = true;

    let index = 0;
function showNextLine() {
    if (index < textLines.length) {
        const p = document.createElement("p");
        p.textContent = textLines[index];

        // важно: даём класс, чтобы CSS точно применился
        p.className = "scene-line";

        // только fade-in, без свечения
        p.style.opacity = "0";
        p.style.transition = "opacity 0.8s ease";

        textContainer.appendChild(p);

        // запускаем плавное появление
        requestAnimationFrame(() => {
            p.style.opacity = "1";
        });

        index++;
        setTimeout(showNextLine, 400);
    } else {
        buttonsContainer.innerHTML = `
            <button onclick="findCafe()">Сразу искать кафе</button>
            <button onclick="searchPark()">Обойти парк в поисках улик</button>
        `;
    }
}

    showNextLine();
}

// -------------------- Кафе с досье --------------------
function findCafe() {
    setGameBackground("cafe-fon.png"); // <-- новая картинка для кафе

    game.innerHTML = `
        <h2>Кафе у дороги</h2>
        <p>
        Вы нашли небольшое кафе у дороги. К сожалению, в кафе есть только один провод для зарядки телефона. 
        Вам необходимо сделать выбор, чей телефон вы зарядите. От этого выбора будет зависеть дальнейший ход расследования. 
        Но перед этим изучите наших персонажей.
        </p>
        
        <div id="dossier" style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; justify-content:center;">
            
            <div class="character dossier-card">
                <img src="katya.png" alt="Катя">
                <p><strong>Катя</strong></p>
                <p>
                Статус: выходит замуж<br>
                Характер: заботливая, терпеливая, немного тревожная, не любит конфликты<br>
                Любит: готовить, планировать события, смотреть реалити-шоу
                </p>
            </div>

            <div class="character dossier-card">
                <img src="lena.png" alt="Лена">
                <p><strong>Лена</strong></p>
                <p>
                Статус: свободна<br>
                Характер: эмоциональная, импульсивная, легко загорается идеями, быстро остывает<br>
                Любит: вечеринки, новые знакомства, спонтанные поездки, снимать сторис
                </p>
            </div>

            <div class="character dossier-card">
                <img src="nastya.png" alt="Настя">
                <p><strong>Настя</strong></p>
                <p>
                Статус: замужем<br>
                Характер: наблюдательная, спокойная, умеет слушать, иногда слишком прямолинейная<br>
                Любит: психологию, таро как хобби, прогулки с мужем
                </p>
            </div>

            <div class="character dossier-card">
                <img src="alena.png" alt="Алёна">
                <p><strong>Алёна</strong></p>
                <p>
                Статус: в отношениях, но не афиширует<br>
                Характер: амбициозная, рациональная, ироничная, не любит проявлять слабость<br>
                Любит: работу, спортзал, спорить о смыслах жизни, слушать подкасты
                </p>
            </div>

            <div class="character dossier-card">
                <img src="vita.png" alt="Вита">
                <p><strong>Вита</strong></p>
                <p>
                Статус: замужем<br>
                Характер: мягкая, эмпатичная, умеет сглаживать углы, но многое держит в себе<br>
                Любит: уют, долгие разговоры на кухне, прогулки у воды, фотографировать
                </p>
            </div>

        </div>
    `;

    // Навешиваем клик на карточки
    document.querySelectorAll('.dossier-card').forEach(card => {
        card.addEventListener('click', () => {
            showDossierFull(card);
        });
    });

    addChargeButtons();
}


// -------------------- Увеличение карточки --------------------
function showDossierFull(cardElement) {

    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.opacity = 0;
    overlay.style.transition = 'opacity 0.3s';

    const clone = cardElement.cloneNode(true);
    clone.style.background = '#111';
    clone.style.padding = '30px';
    clone.style.borderRadius = '15px';
    clone.style.maxWidth = '600px';
    clone.style.width = '90%';
    clone.style.transform = 'scale(0.7)';
    clone.style.transition = 'transform 0.3s';
    clone.style.color = 'white';
    clone.style.textAlign = 'center';
    clone.style.boxShadow = '0 0 30px rgba(255,140,0,0.5)';

    const img = clone.querySelector('img');
    if (img) {
        img.style.width = '100%';
        img.style.maxWidth = '400px';
        img.style.borderRadius = '12px';
        img.style.marginBottom = '20px';
    }

    overlay.appendChild(clone);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        clone.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        clone.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}


// -------------------- Кнопки зарядки --------------------
function addChargeButtons() {

    const buttonsContainer = document.createElement("div");
    buttonsContainer.style.marginTop = "30px";
    buttonsContainer.style.display = "flex";
    buttonsContainer.style.flexDirection = "column";
    buttonsContainer.style.gap = "10px";
    buttonsContainer.style.alignItems = "center";

    buttonsContainer.innerHTML = `
        <button onclick="chargeKatya()">Зарядить телефон Кати</button>
        <button onclick="chargeAlena()">Зарядить телефон Алёны</button>
        <button onclick="chargeNastya()">Зарядить телефон Насти</button>
    `;

    document.getElementById("dossier").after(buttonsContainer);
}


// -------------------- Стили карточек (один раз) --------------------
const style = document.createElement('style');
style.innerHTML = `
    #dossier .character {
        text-align: center;
        cursor: pointer;
        border-radius: 12px;
        padding: 12px;
        background: #1f1f2b;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        max-width: 180px;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    #dossier .character img {
        width: 120px;
        height: 150px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 10px;
    }

    #dossier .character p {
        margin: 5px 0;
        color: #e6e6e6;
        font-size: 13px;
        line-height: 1.4;
    }

    #dossier .character strong {
        color: #ffa500;
        font-size: 15px;
    }

    #dossier .character:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px #ffa500;
    }

    button {
        padding: 10px 15px;
        font-size: 15px;
        border-radius: 8px;
        background-color: #2e2e3e;
        color: #fff;
        border: 1px solid #444;
        cursor: pointer;
        transition: 0.3s;
    }

    button:hover {
        background-color: #4a4a6a;
        box-shadow: 0 0 10px #ffa500;
    }
`;
document.head.appendChild(style);

// -------------------- Линия сюжета Кати --------------------
function chargeKatya() {
    game.innerHTML = `
        <h2>Телефон Кати</h2>
        <p>Вы зарядили телефон Кати. В галерее её фото были только фото с ресторана. В ресторане кушали, пили и участвовали в конкурсах ведущего.</p>
        
        <div style="display:flex; gap:15px; flex-wrap: wrap; justify-content:center; margin-top:15px;">
            <img src="unnamed (6).jpg" class="katya-img" style="width:320px; height:auto; border-radius:10px; cursor:pointer;">
            <img src="unnamed (7).jpg" class="katya-img" style="width:320px; height:auto; border-radius:10px; cursor:pointer;">
            <img src="unnamed (8).jpg" class="katya-img" style="width:320px; height:auto; border-radius:10px; cursor:pointer;">
        </div>

        <p style="margin-top:30px; font-size:18px;">
        Вы можете выбрать второй телефон для зарядки.
        </p>

        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px; max-width:300px;">
            <button onclick="chargeLena()">Телефон Лены</button>
            <button onclick="chargeNastyafromKatya()">Телефон Насти</button>
            <button onclick="chargeVita()">Телефон Виты</button>
        </div>
    `;

    // Обработчики клика на картинки
    const imgs = document.querySelectorAll('.katya-img');
    imgs.forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}

// -------------------- Просмотр картинки на пол-экрана --------------------
function showImageFullScreen(src) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.transition = 'opacity 0.3s';
    overlay.style.opacity = 0;

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '50%';
    img.style.maxHeight = '80%';
    img.style.borderRadius = '10px';
    img.style.boxShadow = '0 0 20px rgba(255,255,255,0.5)';
    img.style.transform = 'scale(0.7)';
    img.style.transition = 'transform 0.3s';

    overlay.appendChild(img);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        img.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        img.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}

// -------------------- Телефон Виты (мини-игра с паролем) --------------------
let vitaAttempts = 0;
const vitaPassword = "0360";

// --- UI сообщения на экране телефона ---
function showVitaMessage(text, type = "info") {
    const box = document.getElementById("vitaMsg");
    if (!box) return;

    box.style.display = "block";

    // поддержка переносов строк
    box.innerHTML = String(text).replace(/\n/g, "<br>");

    if (type === "error") {
        box.style.background = "rgba(255, 80, 80, 0.12)";
        box.style.border = "1px solid rgba(255, 80, 80, 0.25)";
    } else {
        box.style.background = "rgba(120, 160, 255, 0.12)";
        box.style.border = "1px solid rgba(120, 160, 255, 0.25)";
    }
}

function clearVitaMessage() {
    const box = document.getElementById("vitaMsg");
    if (!box) return;
    box.style.display = "none";
    box.innerHTML = "";
}

// -------------------- Экран ввода пароля --------------------
function chargeVita() {
    vitaAttempts = 0;

    game.innerHTML = `
        <h2>Телефон Виты</h2>
        <p>Телефон включился. Экран заблокирован.</p>
        <p>Введите 4-значный пароль.</p>

        <div style="margin-top:20px;">
            <input type="password" id="vitaInput" maxlength="4"
                style="font-size:22px; padding:10px; width:140px; text-align:center; border-radius:10px; border:none; outline:none;">
        </div>

        <div style="margin-top:15px;">
            <button onclick="checkVitaPassword()">Разблокировать</button>
        </div>

        <p style="margin-top:20px;">Попыток осталось: <span id="attemptsLeft">5</span></p>

        <div id="vitaMsg"
             style="margin-top:16px; padding:12px 14px; border-radius:12px; 
                    background: rgba(255,255,255,0.08); 
                    color: rgba(255,255,255,0.9);
                    font-size:16px; line-height:1.35;
                    display:none;">
        </div>
    `;

    const inputEl = document.getElementById("vitaInput");

    // Enter = разблокировать
    inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") checkVitaPassword();
    });

    inputEl.focus();
}

function checkVitaPassword() {
    const inputEl = document.getElementById("vitaInput");
    const input = (inputEl?.value || "").trim();

    clearVitaMessage();

    // если не 4 цифры — не тратим попытку
    if (!/^\d{4}$/.test(input)) {
        showVitaMessage("Введите ровно 4 цифры.", "error");
        return;
    }

    if (input === vitaPassword) {
        openVitaPhone();
        return;
    }

    vitaAttempts++;

    // базовая ошибка
    showVitaMessage("Пароль неверный.", "error");

    // подсказки по попыткам: 1 / 3 / 4
    if (vitaAttempts === 1) {
        showVitaMessage(
            "Пароль неверный.\n\nИз досье Виты — характер: мягкая, умеет сглаживать углы, многое держит в себе.",
            "info"
        );
    }

    if (vitaAttempts === 3) {
        showVitaMessage(
            "Пароль неверный.\n\nОна всегда округляет. Не любит углы.",
            "info"
        );
    }

    if (vitaAttempts === 4) {
        showVitaMessage(
            "Пароль неверный.\n\nПервая цифра кода — скорее всего 0. А дальше… полный круг замкнулся.",
            "info"
        );
    }

    // блокировка после 5-й ошибки
    if (vitaAttempts >= 5) {
        game.innerHTML = `
            <h2>Телефон Виты заблокирован</h2>
            <p>Слишком много попыток. Телефон временно заблокирован.</p>
            <p>Придётся искать другие способы узнать правду.</p>
            <button onclick="showMoveOnAfterSecondPhone()">Двигаться дальше</button>
        `;
        return;
    }

    document.getElementById("attemptsLeft").textContent = 5 - vitaAttempts;
    inputEl.value = "";
    inputEl.focus();
}

// -------------------- Если пароль верный --------------------
function openVitaPhone() {
    game.innerHTML = `
        <h2>Телефон Виты разблокирован</h2>
        <p>
        Экран загорается. Сразу появляется 17 пропущенных от мужа Виты. 
        Также в галерее есть несколько ночных фотографий в ресторане, 
        на улице, фото около велосипедов, фото неизвестной квартиры и каких-то незнакомых парней, фото с вечеринки 80х, а также фото с ночного парка аттракционов.
        </p>

        <div style="display:flex; flex-direction:column; gap:20px; margin-top:20px; align-items:center;">
            <img src="phone vita.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="unnamed (6).jpg" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="phone vita 2.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="phone vita katya.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="phone vita kv1.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="phone vita kv2.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="lena phone.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
            <img src="phone vita1.png" class="vita-img"
                 style="width:400px; border-radius:10px; cursor:pointer;">
        </div>

        <div style="margin-top:30px; text-align:center;">
            <button onclick="showMoveOnAfterSecondPhone()">Двигаться дальше</button>
        </div>
    `;

    // Добавляем открытие на весь экран
    document.querySelectorAll('.vita-img').forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}


function chargeAlena() {
    game.innerHTML = `
        <h2>Телефон Алёны</h2>
        <p>
        После того, как вы зарядили телефон Алёны, вы посмотрели в галерею снимков. 
        В галерее есть фото, где девушки только недавно пришли в ресторан, сделано в 18:12. 
        Дальше фото как девушки катаются ночью на велосипедах по городу. 
        Следующее фото — Лена мчится на велосипеде на какого-то парня. Фото сделаны в 22:03-22:10.
        </p>

        <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content:center;">
            <div style="width:400px; height:auto; border-radius:10px; overflow:hidden;">
                <img src="Main1.png" class="zoom-img" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
            </div>
            <div style="width:400px; height:auto; border-radius:10px; overflow:hidden;">
                <img src="phone alena1.jpeg" class="zoom-img" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
            </div>
            <div style="width:400px; height:auto; border-radius:10px; overflow:hidden;">
                <img src="phone alena2.png" class="zoom-img" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
            </div>
        </div>

        <p style="margin-top:30px; font-size:18px;">
        Вы можете выбрать второй телефон для зарядки.
        </p>

        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px; max-width:300px;">
            <button onclick="chargeLena()">Телефон Лены</button>
            <button onclick="chargeNastyafromKatya()">Телефон Насти</button>
            <button onclick="chargeVita()">Телефон Виты</button>
        </div>
    `;

    // Навешиваем анимацию увеличения
    const images = document.querySelectorAll('.zoom-img');
    images.forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}

// -------------------- Функция для увеличения картинки --------------------
function showImageFullScreen(src) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.opacity = 0;
    overlay.style.transition = 'opacity 0.3s';

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '80%';
    img.style.maxHeight = '80%';
    img.style.borderRadius = '12px';
    img.style.boxShadow = '0 0 30px rgba(255,140,0,0.5)';
    img.style.transform = 'scale(0.7)';
    img.style.transition = 'transform 0.3s';

    overlay.appendChild(img);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        img.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        img.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}

function chargeNastyafromKatya () {
    game.innerHTML = `
        <h2>Телефон Насти</h2>

        <p>
        После того, как вы зарядили телефон Насти, вы посмотрели в галерею снимков. 
        Там было только одно фото с ресторана — начало вечера.
        </p>

        <p>
        В переписках Настя нашла диалог, где писала своей знакомой, 
        что они скоро приедут к ней на вечеринку.
        </p>

        <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-top:20px;">
            <img src="Screenshot_6.png" class="nastya-img" 
                 style="width:400px; height:auto; border-radius:10px; cursor:pointer;">

            <img src="unnamed.jpg" class="nastya-img" 
                 style="width:400px; height:auto; border-radius:10px; cursor:pointer;">
        <button onclick="showMoveOnAfterSecondPhone()">Двигаться дальше</button>
</div>
    `;

    // Добавляем обработчики клика для увеличения картинок
    const imgs = document.querySelectorAll('.nastya-img');
    imgs.forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}

// -------------------- Функция для увеличения картинки (можно использовать общую) --------------------
function showImageFullScreen(src) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.transition = 'opacity 0.3s';
    overlay.style.opacity = 0;

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '50%';
    img.style.maxHeight = '80%';
    img.style.borderRadius = '10px';
    img.style.boxShadow = '0 0 20px rgba(255,255,255,0.5)';
    img.style.transform = 'scale(0.7)';
    img.style.transition = 'transform 0.3s';

    overlay.appendChild(img);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        img.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        img.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}

function chargeLena() {
   lenaOpened = true;
game.innerHTML = `
        <h2>Телефон Лены</h2>

        <p>
        В телефоне Лены вы сразу увидели пропущенные звонки ночью в 1:02 
        от неизвестного номера 555-0123.
        </p>

        <p>
        В галерее пусто. В историях Телеграмма — фото и видео с вечеринки 
        в стиле 80-х. Также есть переписка с её знакомой о том, что девушки 
        едут к ней в Гатчину.
        </p>

        <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-top:20px;">
            <div style="width:400px; height:auto; border-radius:10px; overflow:hidden;">
                <img src="lena phone.png" alt="Фото" class="zoom-img" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
            </div>

            <div style="width:400px; height:auto; border-radius:10px; overflow:hidden;">
                <img src="Screenshot_7.png" alt="Фото" class="zoom-img" style="width:100%; height:100%; object-fit:cover; border-radius:10px;">
            </div>

            <button onclick="showMoveOnAfterSecondPhone()">Двигаться дальше</button>
        </div>
    `;

    // Навешиваем анимацию увеличения
    const images = document.querySelectorAll('.zoom-img');
    images.forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}

// -------------------- Функция для увеличения картинки --------------------
function showImageFullScreen(src) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.opacity = 0;
    overlay.style.transition = 'opacity 0.3s';

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '80%';
    img.style.maxHeight = '80%';
    img.style.borderRadius = '12px';
    img.style.boxShadow = '0 0 30px rgba(255,140,0,0.5)';
    img.style.transform = 'scale(0.7)';
    img.style.transition = 'transform 0.3s';

    overlay.appendChild(img);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        img.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        img.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}

function chargeNastya() {
    game.innerHTML = `
        <h2>Телефон Насти</h2>

        <p>
        После того, как вы зарядили телефон Насти, вы посмотрели в галерею снимков. 
        Там было только одно фото с ресторана — начало вечера.
        </p>

        <p>
        В переписках Настя нашла диалог, где писала своей знакомой, 
        что они скоро приедут к ней на вечеринку.
        </p>

        <div style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-top:20px;">
            <img src="Screenshot_6.png" class="nastya-img" 
                 style="width:400px; height:auto; border-radius:10px; cursor:pointer;">

            <img src="unnamed.jpg" class="nastya-img" 
                 style="width:400px; height:auto; border-radius:10px; cursor:pointer;">
        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px; max-width:300px;">
            <button onclick="chargeLena()">Телефон Лены</button>
            <button onclick="chargeVita()">Телефон Виты</button>
        </div>

    `;

    // Добавляем обработчики клика для увеличения картинок
    const imgs = document.querySelectorAll('.nastya-img');
    imgs.forEach(img => {
        img.addEventListener('click', () => {
            showImageFullScreen(img.src);
        });
    });
}

// -------------------- Функция для увеличения картинки (можно использовать общую) --------------------
function showImageFullScreen(src) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.cursor = 'pointer';
    overlay.style.transition = 'opacity 0.3s';
    overlay.style.opacity = 0;

    const img = document.createElement('img');
    img.src = src;
    img.style.maxWidth = '50%';
    img.style.maxHeight = '80%';
    img.style.borderRadius = '10px';
    img.style.boxShadow = '0 0 20px rgba(255,255,255,0.5)';
    img.style.transform = 'scale(0.7)';
    img.style.transition = 'transform 0.3s';

    overlay.appendChild(img);
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.style.opacity = 1;
        img.style.transform = 'scale(1)';
    }, 10);

    overlay.addEventListener('click', () => {
        img.style.transform = 'scale(0.7)';
        overlay.style.opacity = 0;
        setTimeout(() => document.body.removeChild(overlay), 300);
    });
}
// -------------------- Кнопка "Двигаться дальше" --------------------
function showMoveOnAfterSecondPhone() {
    game.innerHTML = `
        <h2>Воспоминания о той ночи</h2>
        <p>И так, вы уже немного вспомнили о той ночи.. подумайте над тем, что вы узнали.</p>
        <p>Дальше действие продолжается...</p>
        <p id="timerText" style="font-size:18px; font-weight:600; margin-top:20px;">
            Осталось времени: 1:30
        </p>
    `;

    let timeLeft = 05;
    const timerText = document.getElementById('timerText');

    const countdown = setInterval(() => {
        timeLeft--;

        const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const seconds = (timeLeft % 60).toString().padStart(2, '0');
        timerText.textContent = `Осталось времени: ${minutes}:${seconds}`;

        // Когда время закончилось — автоматически звонок
        if (timeLeft <= 0) {
            clearInterval(countdown);
            triggerLenaCall();
        }
    }, 1000);
}

function triggerLenaCall() {
    const introText = lenaOpened
        ? "Резко вас обрывает звонок на телефон Лены. Экран вспыхивает — входящий вызов от неизвестного номера."
        : "Пока вы обсуждали дальнейший план действий, Лена смогла зарядить телефон всего на пару процентов. И в этот момент — резкий входящий звонок от неизвестного номера.";

    callState = {
        mode: null,
        tone: "neutral",
        knowsWhere: false,
        knowsTime: false,
        knowsName: false,
        knowsBike: false
    };

    game.innerHTML = `
        <h2>Входящий звонок</h2>
        <p>${introText}</p>
        <p><strong>Номер:</strong> 555-0123</p>
        <p>Лена шепчет: «Это тот самый номер… Что отвечаем?»</p>

        <h3>Решение команды:</h3>
        <button onclick="callStart('calm')">Ответить спокойно</button>
        <button onclick="callStart('speaker')">Ответить и включить громкую связь</button>
        <button onclick="callStart('who')">Ответить резко: «Ты кто вообще?»</button>
        <button onclick="callStart('drop')">Сбросить</button>
    `;
playIphoneRingThenResumeBg();
}

function callStart(mode) {
    // ❗Сбросить нельзя — "промахнулись и ответили"
    if (mode === "drop") {
        game.innerHTML = `
            <h2>Ой…</h2>
            <p>Ой, кажется вы промахнулись и ответили на звонок.</p>
            <p><strong>Придётся выкручиваться.</strong></p>
            <button onclick="callStart('calm')">Продолжить</button>
        `;
        return;
    }

    callState.mode = mode;
    if (mode === "who") callState.tone = "hard";

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>— Ооо, ну привет, Ленка! наконец-то дозвонился. Ну-ка, а где вы? До сих пор за хлебом не сходили? Прям моего батю напомнили.</p>
        <p>Лена нервно глотает: «Что ему сказать?»</p>

        <h3>Выберите ответ:</h3>
        <button onclick="callQ1('what')">«В смысле? Ты о чём?»</button>
        <button onclick="callQ1('soft')">«Я тебя не знаю. Объясни нормально о чем ты.»</button>
        <button onclick="callQ1('hard')">«Не умничай. Кто ты и откуда номер?»</button>
    `;
}

function callQ1(choice) {
    if (choice === "hard") callState.tone = "hard";
    if (choice === "soft") callState.tone = "soft";

    const toneLine = callState.tone === "hard"
        ? "— Ого. Интересненько..."
        : callState.tone === "soft"
         ? "— Да я без наезда…"
        : "— А что мы такие недовольные? Вчера были намного приятнее.";

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${toneLine}</p>
        <p>— А что говорить? мы с вами неплохо сидели, общались. А потом вы просто резко захотели в магазин зачем-то. Сказали: «минут на 15» — и всё. Не вернулись. Нам обидно так-то.</p>
        <p>Лена смотрит на вас: «Какие 15 минут? Какой к черту магазин?»</p>

        <h3>Что спросить дальше?</h3>
        <button onclick="callQ2('who')">«Ты вообще кто?»</button>
        <button onclick="callQ2('where')">«Где мы сидели с вами?»</button>
        <button onclick="callQ2('time')">«До скольки мы были вместе?»</button>
        <button onclick="callQ2('giggle')">«Ой… прости. Мы реально не помним.»</button>
    `;
}

function callQ2(q) {
    let answer = "";

    if (q === "who") {
        callState.knowsName = true;
        answer = "— Марк.";
    }

    // 
    if (q === "where") {
        callState.knowsWhere = true;
        answer = "— Ууу, алкашня... дома мы сидели.";
    }

    if (q === "time") {
        callState.knowsTime = true;
        answer = "— Нууу, не помню, где-то около часа ночи вы исчезли.";
    }

    if (q === "giggle") {
        callState.tone = "soft";
        answer = "— Ну вот… так бы сразу, малышка.";
    }

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${answer}</p>
        <p>Лена тихо: «Он отвечает как будто специально коротко… Какой противный.»</p>

        <h3>Команда выбирает следующий вопрос:</h3>
        <button onclick="callQ3('bike')">«Напомни, как мы познакомились»</button>
        <button onclick="callQ3('address')">«Где ты живёшь? Район/улица»</button>
        <button onclick="callQ3('left')">«Во сколько мы ушли?»</button>
        <button onclick="callQ3('vita')">«Вита была с нами?»</button>
    `;
}

function callQ3(q) {
    let answer = "";

    // ✅ ветка "велосипед" с доп. вопросами и постепенным раскрытием
    if (q === "bike") {
        callState.knowsBike = true;

        game.innerHTML = `
            <h2>Разговор</h2>
            <p>— Сначала на улице пересеклись. Ты, если не помнишь, в меня на полной скорости на велосипеде влетела. У меня до сих пор нога болит, извиниться не хочешь?</p>

            <p style="margin-top:10px;"> Катя вспоминает: «Кажется, что-то такое припоминаю..» Лена шепчет: «Так… и что отвечаем?»</p>

            <h3>Реакция команды:</h3>
            <button onclick="callBikeReply('what')">«И что дальше?»</button>
            <button onclick="callBikeReply('sorry')">«Ой… прости. Ты, наверное, заслужил? Я обычных людей просто так не сбиваю.»</button>
            <button onclick="callBikeReply('hard')">«Мы вообще не помним такого. Не придумывай.»</button>
        `;
        return;
    }

    if (q === "address") {
        callState.knowsWhere = true;
        answer = callState.tone === "hard"
            ? "— Я адреса по телефону не раздаю."
            : "— Санкт-Петербург, район Выборгский.";
    }

    if (q === "left") {
        callState.knowsTime = true;
        answer = "— Вы собрались резко. «Минут на 15 в магазин» — и всё.";
    }

    if (q === "vita") {
        // он уклоняется, чтобы не раскрывать всё быстро
        answer = callState.tone === "hard"
            ? "— Не знаю."
            : "— Была. Потом… вроде с вами ушла. Вы же все сбежали.";
    }

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${answer}</p>

        <p style="margin-top:10px;">Лена закрывает микрофон рукой: «Он как будто специально недоговаривает…»</p>
        <h3>Как держим линию?</h3>
        <button onclick="callQ4('press')">Давим: «Если врёшь — мы идём в полицию»</button>
        <button onclick="callQ4('logic')">Спокойно: «Нам нужны детали, мы ищем Виту»</button>
        <button onclick="callQ4('flirt')">Сыграть мягко: «Ладно… ты нормальный вообще?»</button>
    `;
}

function callBikeReply(type) {
    let text = "";

    if (type === "what") {
        text = "— Да что… поднял тебя. Вы начали смеяться, а потом наконец и извиняться. Потом болтали.";
    }
    if (type === "sorry") {
        callState.tone = "soft";
        text = "— Смешно. Но да… вы сначала ржали, потом извинялись.";
    }
    if (type === "hard") {
        callState.tone = "hard";
        text = "— Зачем мне придумывать?";
    }

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${text}</p>
        <p>— Вы сказали, что девичник отмечаете, хотите жестко отжечь эту ночь, чтобы запомнить на всю жизнь. Хахха, забавно, что вы по итогу как будто все забыли.»</p>

        <h3>Что уточнить?</h3>
        <button onclick="callBikeAfter('home')">«И что было дальше?»</button>
        <button onclick="callBikeAfter('why')">«Почему мы поехали к тебе?»</button>
    `;
}

function callBikeAfter(type) {
    let text = "";

    if (type === "home") {
        text = "— Разговорились. Я позвал. У меня друзья были. Музыка, алкоголь.";
    }
    if (type === "why") {
        text = "— Вы сами согласились.»…";
    }

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${text}</p>
        <p>— Обычная квартира. Ничего такого.</p>

        <button onclick="callQ3Continue()">Дальше</button>
    `;
}

function callQ3Continue() {
    game.innerHTML = `
        <h2>Разговор</h2>
        <p>Лена смотрит на вас: «Что ещё спросим?»</p>

        <h3>Следующий вопрос:</h3>
        <button onclick="callQ3('address')">«Где ты живёшь?»</button>
        <button onclick="callQ3('left')">«Во сколько мы ушли?»</button>
        <button onclick="callQ3('vita')">«Что с Витой?»</button>
    `;
}

function callQ4(choice) {
    let answer = "";

    if (choice === "press") {
        callState.tone = "hard";
        answer = "— Да идите куда хотите.";
    }

    if (choice === "logic") {
        callState.tone = "neutral";
        answer = "— Окей. Я вам говорю как было.";
    }

    // ✅ твоя правка
    if (choice === "flirt") {
        callState.tone = "soft";
        answer = "— Нормальный. Вы просто… ооочень пьяные были ночью.";
    }

    // концовка: он переходит границы и зовёт снова
    const dirty = callState.tone === "soft"
        ? "— Слушайте… а может вы сегодня ко мне снова? Я вам покажу, как «за хлебом ходить», ахахх."
        : "— Малышки, хоть вы и кинули нас, но я всегда вам рад)) Хотите — приезжайте. Адрес скинуть?";

    game.innerHTML = `
        <h2>Разговор</h2>
        <p>${answer}</p>
        <p style="margin-top:12px;"><strong>Он явно переходит границы:</strong></p>
        <p>${dirty}</p>

        <h3>Как отвечаем?</h3>
        <button onclick="callEnd('hang')">Сбросить звонок</button>
        <button onclick="callEnd('freeze')">Сухо: «Нам не до этого.»</button>
        <button onclick="callEnd('prov')">Провокация: «Скинь адрес, где ты живешь.»</button>
    `;
}

function callEnd(type) {
    let outro = "";

    if (type === "hang") {
        outro = "Вы сбрасываете звонок. Лена морщится: «Фу… мерзко».";
    }

    if (type === "freeze") {
        outro = "— Не ломайтесь как дети, приезжайте сегодня ночью снова, мы вас ждем)).";
    }

    if (type === "prov") {
        outro = "— О, вот это разговор… Ладно.\nПриходит сообщение с ориентиром. И ещё одно: «Только без полиции, ок?»";
    }

    game.innerHTML = `
        <h2>После звонка</h2>
        <p>${outro.replace(/\n/g, "<br>")}</p>

        <p style="margin-top:12px;">
        На этом моменте телефон Лены снова разрядился.
        </p>

        <button onclick="afterCallNext()">Что делать дальше?</button>
    `;
}

function afterCallNext() {
    game.innerHTML = `
        <h2>После разговора</h2>
        <p>Вы уже намного больше помните о вчерашней ночи.</p>
        <p>Но главный вопрос остаётся: где Вита сейчас? Куда и в какой момент она пропала?</p>

        <button onclick="startClueDiscussion()">Обсудить всё, что удалось вспомнить</button>
    `;
}
// ==================== ЭТАП: ОБСУЖДЕНИЕ УЛИК ====================

// ==================== ПРОДОЛЖЕНИЕ ПОСЛЕ ЗВОНКА МАРКА: ОБСУЖДЕНИЕ + ХРОНОЛОГИЯ ====================
// Обновлено под твои требования:
// ✅ Единственно верная хронология (можно с пропусками): 
// "ресторан" → "велосипеды" → "столкновение" → "марк" → "квартира" → "магазин" → "вечеринка 80х" → "парк аттракционов" → "гатчина"
// ✅ Если каких-то слов нет — хронология начинается с первого найденного по этому порядку.
// ✅ Убраны "такси" и "пропажа виты" (ни в словаре, ни в хронологии).

// --- 1) Синонимы -> канонические ключи (добавляй сколько хочешь) ---
const clueAliases = {
  // ресторан
  "ресторан": "ресторан",
  "паб": "ресторан",
  "бар": "ресторан",
  "рестик": "ресторан",

  // велосипеды
  "велосипед": "велосипеды",
  "велосипеды": "велосипеды",
  "велики": "велосипеды",
  "велик": "велосипеды",

  // столкновение
  "столкновение": "столкновение",
  "врезалась": "столкновение",
  "врезались": "столкновение",
  "врезалась на велосипеде": "столкновение",
  "влетела": "столкновение",
  "сбила": "столкновение",

  // Марк
  "марк": "марк",
  "марик": "марк",
  "парень": "марк",
  "мужик": "марк",

  // квартира
  "квартира": "квартира",
  "дом": "квартира",
  "у него дома": "квартира",
  "к нему домой": "квартира",

  // магазин
  "магазин": "магазин",
  "хлеб": "магазин",
  "за хлебом": "сбежали",
  "в магазин": "магазин",

  // вечеринка 80х
  "вечеринка 80х": "вечеринка 80х",
  "вечеринка 80": "вечеринка 80х",
  "80х": "вечеринка 80х",
  "вписка 80х": "вечеринка восьмидесятых",

  // парк аттракционов
  "парк аттракционов": "парк аттракционов",
  "аттракционы": "парк аттракционов",
  "парк с аттракционами": "парк аттракционов",

  // гатчина
  "гатчина": "гатчина",
  "приорат": "гатчина",
  "приоратский": "гатчина",
  "приоратский парк": "гатчина"
};

// --- 2) Единственно верная master-хронология ---
const masterTimeline = [
  "ресторан",
  "велосипеды",
  "столкновение",
  "марк",
  "квартира",
  "магазин",
  "вечеринка 80х",
  "парк аттракционов",
  "гатчина"
];

// Храним найденные канонические улики
let foundClues = [];

// ==================== СТАРТ: обсуждение улик ====================
function startClueDiscussion(reset = false) {
  if (reset) foundClues = [];

  game.innerHTML = `
    <h2>Обсуждение</h2>
    <p>Запишите все локации, людей и события ночи, которые вы вспомнили.</p>

    <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <input id="clueInput" type="text" placeholder="Например: поход к другу/пляж"
        style="padding:10px; font-size:16px; border-radius:10px; border:none; width:280px; outline:none;">
      <button onclick="checkClue()">Добавить</button>
    </div>

    <p id="clueStatus" style="margin-top:12px; font-weight:600; text-align:center;"></p>

    <div style="margin-top:18px;">
      <p style="margin-bottom:8px;"><strong>Ваш список:</strong></p>
      <div id="foundCluesWrap" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>
    </div>

    <div style="margin-top:18px; padding:12px; border-radius:14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0 0 10px 0;">
        <strong>Важно:</strong> двигайтесь дальше только если уверены, что записали всё известное.
      </p>
      <button onclick="confirmProceedToOrder()">Двигайтесь дальше</button>
    </div>
  `;

  const input = document.getElementById("clueInput");
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkClue();
  });
  input.focus();

  renderFoundClues(); // <- перерисуем уже найденное
}

function normalizeClue(text) {
  const v = text
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ")
    .replace(/x/g, "х")     // латинская x -> русская х
    .replace(/-/g, "");     // убираем дефисы

  return clueAliases[v] || "";
}

function checkClue() {
  const inputEl = document.getElementById("clueInput");
  const statusEl = document.getElementById("clueStatus");

  const raw = inputEl.value;
  const key = normalizeClue(raw);

  if (!raw.trim()) return;

  if (!key) {
    statusEl.textContent = "Не распознано. Попробуйте написать по-другому.";
    inputEl.value = "";
    inputEl.focus();
    return;
  }

  if (foundClues.includes(key)) {
    statusEl.textContent = "Это уже записано.";
    inputEl.value = "";
    inputEl.focus();
    return;
  }

  foundClues.push(key);
  statusEl.textContent = "Записали.";
  inputEl.value = "";
  inputEl.focus();

  renderFoundClues();
}

function renderFoundClues() {
  const wrap = document.getElementById("foundCluesWrap");
  if (!wrap) return;
  wrap.innerHTML = "";

  // сортируем найденные по masterTimeline (неизвестные уходят в конец)
  const ordered = [...foundClues].sort((a, b) => {
    const ia = masterTimeline.indexOf(a);
    const ib = masterTimeline.indexOf(b);
    return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
  });

  ordered.forEach((key) => {
    const chip = document.createElement("div");
    chip.textContent = formatClue(key);
    chip.style.padding = "10px 12px";
    chip.style.borderRadius = "14px";
    chip.style.background = "rgba(255,255,255,0.08)";
    chip.style.border = "1px solid rgba(255,255,255,0.15)";
    chip.style.minWidth = "190px";
    chip.style.textAlign = "center";
    wrap.appendChild(chip);
  });
}
// ==================== ПЕРЕХОД ДАЛЬШЕ ====================
function confirmProceedToOrder() {
  const usable = masterTimeline.filter(x => foundClues.includes(x));

  game.innerHTML = `
    <h2>Перед хронологией</h2>
    <p>У вас записано: <strong>${usable.length}</strong> ${decline(usable.length, "событие", "события", "событий")}.</p>
    <p>Хронология будет строиться <strong>только из того, что вы записали</strong>.</p>

    <button onclick="startClueDiscussion()">Вернуться и дописать</button>
    <button onclick="showOrderFromFound()">Я уверен(а), дальше</button>
  `;
}

function decline(n, one, few, many) {
  const n10 = n % 10;
  const n100 = n % 100;
  if (n10 === 1 && n100 !== 11) return one;
  if (n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return few;
  return many;
}

// ==================== ХРОНОЛОГИЯ ИЗ НАЙДЕННЫХ ====================
let selectedOrder = [];
let orderPool = [];

function showOrderFromFound() {
  const usable = masterTimeline.filter(x => foundClues.includes(x));

  if (usable.length < 2) {
    game.innerHTML = `
      <h2>Слишком мало данных</h2>
      <p>Вы записали слишком мало, чтобы восстановить хронологию.</p>
      <button onclick="startClueDiscussion()">Вернуться</button>
    `;
    return;
  }

  selectedOrder = [];
  orderPool = shuffleArray([...usable]);

  game.innerHTML = `
    <h2>Восстановите хронологию</h2>
    <p>Нажимайте на события в том порядке, как всё происходило.</p>

    <div id="orderPool" style="margin-top:15px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>

    <h3 style="margin-top:20px; text-align:center;">Ваша цепочка</h3>
    <div id="orderSelected" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>

    <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="undoOrder()">Отменить</button>
      <button onclick="resetOrderFromFound()">Сбросить</button>
      <button onclick="checkOrderFromFound()">Проверить</button>
    </div>

    <p id="orderStatus" style="margin-top:12px; font-weight:600; text-align:center;"></p>
  `;

  renderOrderUI();
}

function renderOrderUI() {
  const poolEl = document.getElementById("orderPool");
  const selEl = document.getElementById("orderSelected");
  if (!poolEl || !selEl) return;

  poolEl.innerHTML = "";
  selEl.innerHTML = "";

  orderPool.forEach(item => {
    const btn = document.createElement("button");
    btn.textContent = formatClue(item);
    btn.style.minWidth = "200px";
    btn.onclick = () => pickOrderItem(item);
    poolEl.appendChild(btn);
  });

  selectedOrder.forEach((item, idx) => {
    const chip = document.createElement("div");
    chip.textContent = `${idx + 1}. ${formatClue(item)}`;
    chip.style.padding = "10px 12px";
    chip.style.borderRadius = "14px";
    chip.style.background = "rgba(255,255,255,0.08)";
    chip.style.border = "1px solid rgba(255,255,255,0.15)";
    chip.style.minWidth = "240px";
    chip.style.textAlign = "center";
    selEl.appendChild(chip);
  });
}

function pickOrderItem(item) {
  orderPool = orderPool.filter(x => x !== item);
  selectedOrder.push(item);
  renderOrderUI();
}

function undoOrder() {
  if (!selectedOrder.length) return;
  const last = selectedOrder.pop();
  orderPool.push(last);
  renderOrderUI();
}

function resetOrderFromFound() {
  const usable = masterTimeline.filter(x => foundClues.includes(x));
  selectedOrder = [];
  orderPool = shuffleArray([...usable]);
  renderOrderUI();
}

// ✅ Проверка: выбранная цепочка должна быть в порядке masterTimeline (с пропусками)
function checkOrderFromFound() {
  const statusEl = document.getElementById("orderStatus");
  if (!statusEl) return;

  const usable = masterTimeline.filter(x => foundClues.includes(x));

  if (selectedOrder.length !== usable.length) {
    statusEl.textContent = `Нужно использовать все события. Осталось выбрать: ${usable.length - selectedOrder.length}`;
    return;
  }

  let lastIndex = -1;
  for (const item of selectedOrder) {
    const idx = masterTimeline.indexOf(item);
    if (idx <= lastIndex) {
      statusEl.textContent = "Порядок неверный. Подумайте, что было раньше.";
      return;
    }
    lastIndex = idx;
  }

  statusEl.textContent = "Хронология восстановлена.";
  setTimeout(finalAfterAnalysisFromFound, 900);
}

function finalAfterAnalysisFromFound() {
  const chain = selectedOrder.map(formatClue).join(" → ");

  game.innerHTML = `
    <h2>Вы сделали выводы</h2>
    <p>Ваша восстановленная цепочка:</p>

    <div style="margin-top:10px; padding:14px; border-radius:14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">${chain}</p>
    </div>

    <p style="margin-top:14px;">
      Теперь вы можете выбирать следующий шаг расследования.
    </p>

    <button onclick="showDiscussionAfterTimeline()">Обсудить всё, что вспомнили</button>
  `;
}

// ==================== ВСПОМОГАТЕЛЬНЫЕ ====================
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function formatClue(key) {
  const map = {
    "ресторан": "Ресторан",
    "велосипеды": "Велосипеды",
    "столкновение": "Столкновение",
    "марк": "Марк",
    "квартира": "Квартира",
    "магазин": "«За хлебом»",
    "вечеринка 80х": "Вечеринка 80-х",
    "парк аттракционов": "Парк аттракционов",
    "гатчина": "Гатчина"
  };
  return map[key] || key;
}
// ==================== ОБСУЖДЕНИЕ ПОСЛЕ ХРОНОЛОГИИ ====================

// Тексты обсуждения по каждому событию
const discussionLines = {
  "ресторан": "В ресторане всё начиналось нормально: тосты, еда, сплетни, фото. Кажется, мы выиграли какой-то конкурс ведущего и получили подарки от ресторана, а потом что-то сказали про велосипеды и ушли из заведения.",
  "велосипеды": "Потом были велосипеды — ночные улицы, смех, скорость. Мы катались по городу на арендованных велосипедах, точно!",
  "столкновение": "В какой-то момент, Лена как обычно потеряла контроль и наехала на какого-то парня.",
  "марк": "Это же и был Марк! Мы даже мило пообщались. Он выглядел супер милым, дружелюбным и веселым.",
  "квартира": "Марк позвал к себе домой, сказал, там его друг ждет, будет музыка, алкоголь, можно в настолки поиграть... но мы пришли и там оказалось два друга, а не один.. потом они предложили сыграть в правду или действие. Еще был алкоголь.. Воспоминания рваные. Кажется, они нам предложили что-то незаконное и нам пришлось срочно сваливать от них.",
  "магазин": "Да, да! мы сказали, что пойдем в магазин зачем-то и срочно уехали. А куда?",
  "вечеринка 80х": "Настя вспоминает: «Тооочно, я же писала знакомой, что мы к ней ворвемся на вечеринку, наверное туда и поехали.»",
  "парк аттракционов": "Кажется, мы еще больше выпили и решили ворваться в парк атракционов, чтобы Катя запомнила этот день навсегда.. А что дальше было? Помню, что мы бежали... по парку наверное дурачились? или от кого-то?",
  "гатчина": "А потом оказались в Гатчине, снова долго ходили по темноте и искали.. что или кого мы искали? Алена вздыхает: Не знаю, по всей видимости, не нашли."
};

// Заглушка, если события нет в найденной игроками хронологии
const memoryGapLine = "кажется тут пробел в памяти..";

// ==================== СОСТОЯНИЕ РАССЛЕДОВАНИЯ ====================

const INVEST = {
  party80Unlocked: false,
  visited: {
    restaurant: false,
    mark: false,
    party80: false
  },
  firstLocationDone: false
};

// Ресторан — какие вопросы уже задали
const REST = {
  asked: {
    main: false,
    time: false,
    bikes: false,
    details: false
  }
};

// ==================== ОБСУЖДЕНИЕ ====================

function showDiscussionAfterTimeline() {
  const picked = new Set(selectedOrder);

  const knownOrdered = masterTimeline.filter(key => picked.has(key));
  const missingCount = masterTimeline.length - knownOrdered.length;

  let html = `
    <h2>Обсуждение</h2>
    <p><strong>Так, давайте теперь по порядку, как было..</strong></p>

    <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
  `;

  knownOrdered.forEach((key, i) => {
    const title = formatClue(key);
    const text = discussionLines[key] || "—";

    html += `
      <div style="
        padding:14px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.12);
      ">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <strong>${i + 1}. ${escapeHtml(title)}</strong>
          <span style="font-size:14px; opacity:0.85;">вспомнили</span>
        </div>
        <p style="margin:10px 0 0 0;">
          ${escapeHtml(text)}
        </p>
      </div>
    `;
  });

  if (missingCount > 0) {
    html += `
      <div style="
        padding:14px; border-radius:14px;
        background: rgba(255, 120, 120, 0.08);
        border: 1px solid rgba(255, 120, 120, 0.20);
      ">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <strong>Провалы в памяти</strong>
          <span style="font-size:14px; opacity:0.9;">${missingCount}</span>
        </div>
        <p style="margin:10px 0 0 0; opacity:0.9;">
          ${escapeHtml(memoryGapLine)}
        </p>
      </div>
    `;
  }

  html += `
    </div>

    <div style="margin-top:18px; text-align:center;">
      <button onclick="nextAfterDiscussion()">Дальше</button>
    </div>
  `;

  game.innerHTML = html;
}

function nextAfterDiscussion() {
  showInvestigationHub();
}

// ==================== ХАБ РАССЛЕДОВАНИЯ ====================

function showInvestigationHub() {
  // До открытия 80-х: выбор только между рестораном и Марком.
  // После открытия 80-х: выбор между Марком и 80-ми (как ты хочешь).
  const beforeUnlock = !INVEST.party80Unlocked;

  const topHint = beforeUnlock
    ? `<p style="opacity:0.9;">Выберите, куда ехать сначала.</p>`
    : `<p style="opacity:0.9;">Теперь у вас есть зацепка про вечеринку. Куда едем?</p>`;

  let html = `
    <h2>Куда ехать?</h2>
    ${topHint}

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:12px;">
  `;

  if (beforeUnlock) {
    html += placeCard(
      "Ресторан",
      INVEST.visited.restaurant ? "проверено" : "не проверяли",
      "goRestaurant()"
    );

    html += placeCard(
      "Квартира Марка",
      INVEST.visited.mark ? "проверено" : "не проверяли",
      "goMark()"
    );
  } else {
    html += placeCard(
      "Квартира Марка",
      INVEST.visited.mark ? "проверено" : "не проверяли",
      "goMark()"
    );

    html += placeCard(
      "Вечеринка 80-х",
      INVEST.visited.party80 ? "проверено" : "не проверяли",
      "startParty80()"
    );
  }

  html += `
    </div>

    <div style="margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="showDiscussionAfterTimeline()" style="opacity:0.85;">Назад к обсуждению</button>
    </div>
  `;

  game.innerHTML = html;
}

function placeCard(title, status, onClick) {
  return `
    <div style="
      padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    ">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <strong>${escapeHtml(title)}</strong>
        <span style="font-size:14px; opacity:0.85;">${escapeHtml(status)}</span>
      </div>
      <div style="margin-top:10px;">
        <button onclick="${onClick}">Поехать</button>
      </div>
    </div>
  `;
}

// ==================== РЕСТОРАН: диалог с выбором вопросов ====================

function goRestaurant() {
setGameBackground("restik.png");  
INVEST.visited.restaurant = true;

  // сброс вопросов
  REST.asked = { main: false, time: false, bikes: false, details: false };

  renderRestaurantDialog(`
    <p>Вы заходите в ресторан. Днём тихо, пахнет кофе. Официант вас узнаёт и улыбается.</p>
    <p><strong>Официант:</strong> О… добрый день, девушки! Как сегодня ваше настроение после вчерашней победы в конкурсе? </p>
    <p style="opacity:0.9;">Что спрашиваем?</p>
  `);
}

function renderRestaurantDialog(introHtml) {
  const btn = (id, text, handler) => {
    const disabled = REST.asked[id] ? "disabled" : "";
    const opacity = REST.asked[id] ? "opacity:0.55;" : "";
    return `<button ${disabled} style="${opacity}" onclick="${handler}">${escapeHtml(text)}</button>`;
  };

  // Кнопка "уйти" появится когда хотя бы 2 вопроса задали (чтобы сцена не была 5 секунд)
  const askedCount = Object.values(REST.asked).filter(Boolean).length;
  const canLeave = askedCount >= 2;

  const leaveBtn = canLeave
    ? `<button onclick="finishRestaurant()">Спасибо, уходим</button>`
    : `<button disabled style="opacity:0.55;">Спасибо, уходим</button>`;

  game.innerHTML = `
    <h2>Ресторан</h2>

    <div style="
      margin-top:15px;
      padding:16px;
      border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
    ">
      ${introHtml}
    </div>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
      ${btn("main", "Добрый день! Ой, а можете рассказать, что было вчера?", "askWaiter('main')")}
      ${btn("time", "Подскажите, вы не помните во сколько мы ушли?", "askWaiter('time')")}
      ${btn("bikes", "Не знаете случайно куда мы пошли после?", "askWaiter('bikes')")}
      ${btn("details", "Подскажите, а как мы победили?", "askWaiter('details')")}
    </div>

    <div style="margin-top:16px; display:flex; justify-content:center;">
      ${leaveBtn}
    </div>
  `;
}

function askWaiter(type) {
  REST.asked[type] = true;

  let add = "";

  if (type === "main") {
    add = `
      <p><strong>Официант:</strong> Вы хорошои отдыхали, потом ведущий объявил конкурс: <em>«Лучшая компания девичника получает скидку 20% на итоговый счёт и огромный сет шотов!»</em></p>
      <p>Вы начали петь, танцевать, отвечать на викторину — и реально вырвали победу, вчера вы прям были главными нашими гостями, покорили всех!</p>
    `;
  }

  if (type === "time") {
    add = `
      <p><strong>Официант:</strong> Хм, если моя память не подводит, то вы ушли примерно в <strong>21:30</strong>. Вы были довольные и очень громкие.</p>
    `;
  }

  if (type === "bikes") {
    add = `
      <p><strong>Официант:</strong> Я слышал обрывок — что-то вроде: <em>«пойдём на велосипеды»</em>. Вы достаточно быстро убежали, после того, как оплатили счет.</p>
    `;
  }

  if (type === "details") {
    add = `
      <p><strong>Официант:</strong> Ведущий гонял вас по коротким вопросам, типа “угадай песню”, “кто быстрее ответит”, “кто громче споёт”, на последок каждая из вас исполнила сольный танец. Вы буквально захватили зал. Люди аплодировали.</p>
    `;
  }

  renderRestaurantDialog(`
    <p>Вы заходите в ресторан. Официант вас узнаёт.</p>
    ${add}
    <p style="opacity:0.9;">Что ещё спросим?</p>
  `);
}

function finishRestaurant() {
  // после первой локации должно всплыть воспоминание Насти
  unlockPartyAfterFirstLocation();
}

// ==================== ОКНО ВОСПОМИНАНИЯ НАСТИ (как ты написала) ====================

function showPartyHintDialog() {
  game.innerHTML = `
    <h2>Воспоминание</h2>

    <div style="
      margin-top:15px;
      padding:16px;
      border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      max-width:600px;
      margin-left:auto;
      margin-right:auto;
    ">
      <p><strong>Настя вдруг замирает.</strong></p>

      <p>— Стоп… Подождите.</p>

      <p>— Я же писала знакомой… Мы собирались к ней на вечеринку в стиле 80-х.</p>

      <p>— Может, к ней тоже заедем? Или сначала проверим остальные места?</p>
    </div>

    <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px; max-width:320px; margin-left:auto; margin-right:auto;">
      <button onclick="startParty80()">Поехать на вечеринку 80-х</button>
      <button onclick="continueOtherLocations()">Сначала проверить другие места</button>
    </div>
  `;
}

function continueOtherLocations() {
  showInvestigationHub();
}

function unlockPartyAfterFirstLocation() {
  // Открываем 80-е один раз
  if (!INVEST.party80Unlocked) {
    INVEST.party80Unlocked = true;
    showPartyHintDialog();
    return;
  }
  showInvestigationHub();
}

// ==================== КВАРТИРА МАРКА: напряжённая мини-игра ====================

// ==================== КВАРТИРА МАРКА: расширенная напряжённая сцена ====================

function goMark() {
  
INVEST.visited.mark = true;
setGameBackground("KVMark.png");
  game.innerHTML = `
    <h2>Квартира Марка</h2>
    <p>Вы находите подъезд и больно знакомую дверь в квартиру, она располагается на 4 этаже. Тяжёлый запах табака и вчерашнего алкоголя.</p>
    <p>Дверь открывает парень из той ночи, вроде, это и есть Марк. Он улыбается слишком широко — как будто ждал.</p>

    <div style="margin-top:14px; padding:14px; border-radius:14px; background: rgba(255,120,120,0.08); border:1px solid rgba(255,120,120,0.20);">
      <p style="margin:0;"><strong>Парень:</strong> Ого… вы вернулись. Готовы продолжить развлекаться??</p>
    </div>

    <h3 style="margin-top:16px;">Как говорить?</h3>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button onclick="markTalk('calm')">Спокойно: «Мы ищем подругу. Расскажи, что было ночью?»</button>
      <button onclick="markTalk('hard')">Жёстко: «Где Вита? И что вы сделали?»</button>
      <button onclick="markTalk('leave')">Сыграть: «Кажется, Мы ошиблись адресом»</button>
    </div>
  `;
}

function markTalk(type) {
  if (type === "hard") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>— Ой-ой… какие мы злые. Может зайдёте? “Поговорим”…</p>
      <p>Изнутри слышны голоса и короткий смех. Вам становится не по себе.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markHardStep('stepback')">Сделать шаг назад и держать дистанцию</button>
        <button onclick="markHardStep('loud')">Сказать громко, чтобы услышали соседи</button>
        <button onclick="markHardStep('call')">Сделать вид, что вы звоните в полицию</button>
      </div>
    `;
    return;
  }

  if (type === "calm") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>Вы стараетесь говорить ровно, без эмоций.</p>
      <p><strong>Парень, начинается повышать тон:</strong> Вита? Да с вами она была. Вы все вместе свалили, я то откуда это знать должен??.</p>
      <p><strong>Катя:</strong> То есть никто тут не оставался?</p>
      <p><strong>Парень:</strong> Не знаю. Я вам ничего не должен, если хотите, то можете сами зайти и все проверить.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markCalmStep('askMore')">Уточнить: «Во сколько мы ушли?»</button>
        <button onclick="markExitStart('elevator')">Не рисковать. Развернуться к лифту</button>
        <button onclick="markExitStart('stairs')">Не рисковать. По лестнице вниз</button>
      </div>
    `;
    return;
  }

  if (type === "leave") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>— Ой, извините… мы ошиблись адресом.</p>
      <p>Он делает полшага на порог. Улыбка не пропадает.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markExitStart('elevator')">Сделать вид, что ждёте лифт</button>
        <button onclick="markExitStart('stairs')">Резко уйти по лестнице</button>
      </div>
    `;
  }
}

function markHardStep(step) {
  if (step === "stepback") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>Вы делаете шаг назад. Парень будто “случайно” делает шаг вперёд.</p>
      <p>Изнутри кто-то говорит: “Кто там?”</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markExitStart('stairs')">Развернуться и уйти по лестнице</button>
        <button onclick="markExitStart('elevator')">Сделать вид, что ждёте лифт</button>
      </div>
    `;
    return;
  }

  if (step === "loud") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>Вы говорите громко: “Мы ищем подругу. Если вы её трогали — будет заявление.”</p>
      <p>Улыбка парня срывается. Он быстро оглядывается в подъезд.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markExitStart('elevator')">Пока он замешкался — к лифту</button>
        <button onclick="markExitStart('stairs')">Пока он замешкался — по лестнице</button>
      </div>
    `;
    return;
  }

  if (step === "call") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p>Вы поднимаете телефон: “Алло? Да, мы у такой-то квартиры…”</p>
      <p>Парень резко меняется в лице: “Эй-эй… без спектаклей.”</p>
      <p>Дверь за его спиной приоткрывается шире. Мелькает силуэт второго.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markExitStart('stairs')">Не ждать — бежать по лестнице</button>
        <button onclick="markExitStart('elevator')">Не ждать — к лифту</button>
      </div>
    `;
  }
}

function markCalmStep(step) {
  if (step === "askMore") {
    game.innerHTML = `
      <h2>Квартира Марка</h2>
      <p><strong>Катя:</strong> Во сколько мы ушли?</p>
      <p><strong>Парень:</strong> Точно не помню ,я ж говорил, что около часу ночи. Неужели вы так выпили, что все между нами забыли? Нам же было так весело.</p>
      <p>Он задерживается в проёме слишком близко. Сзади снова слышен шорох.</p>

      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markExitStart('elevator')">Ок. К лифту</button>
        <button onclick="markExitStart('stairs')">Ок. По лестнице</button>
      </div>
    `;
  }
}

// ====== ОБЩИЙ СТАРТ ВЫХОДА: в любой ветке появляется шум и давление ======

function markExitStart(route) {
  const routeText = route === "elevator"
    ? "Вы отходите к лифту и нажимаете кнопку. Тишина звенит."
    : "Вы разворачиваетесь к лестнице. Шаги гулко отдаются в подъезде.";

  game.innerHTML = `
    <h2>Подъезд</h2>
    <p>${escapeHtml(routeText)}</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,120,120,0.08); border:1px solid rgba(255,120,120,0.20);">
      <p style="margin:0;">
        Из квартиры слышен шум и шорохи. Потом — голоса, ближе.
        <br><strong>— Ну куда же вы… мы с вами ещё не закончили.</strong>
      </p>
    </div>

    <p style="margin-top:12px; opacity:0.9;">Что делаете?</p>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="markConfrontChoice('${route}')">Стоять и игнорировать, продолжать как будто ничего не происходит</button>
      <button onclick="markRunNow('${route}')">Сорваться и бежать</button>
    </div>
  `;
}

// ====== ВАРИАНТ 1: они “держат лицо” (лифт/лестница), парни выходят ======

function markConfrontChoice(route) {
  const routeLine = route === "elevator"
    ? "Лифт не едет. Секунды тянутся неприятно долго."
    : "Вы делаете вид, что просто уходите. Но шаги сзади становятся ближе.";

  game.innerHTML = `
    <h2>Подъезд</h2>
    <p>${escapeHtml(routeLine)}</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,120,120,0.08); border:1px solid rgba(255,120,120,0.20);">
      <p style="margin:0;">
        Дверь открывается шире. Выходят <strong>двое</strong>.
        Один ухмыляется, второй смотрит так, будто вы им что-то должны.
        <br><strong>— Ну куда вы, девочки… останьтесь. Дальше развлекаться.</strong>
      </p>
    </div>

    <p style="margin-top:12px; opacity:0.9;">Девушки сбиваются ближе, защищают друг друга. Что делаете?</p>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="markDefend('shout', '${route}')">Кричать: «Отойдите! Люди! Помогите!»</button>
      <button onclick="markDefend('police', '${route}')">Угрожать: «Полиция уже набрана»</button>
      <button onclick="markDefend('neighbors', '${route}')">Давить: «Соседи услышат, камеры в подъезде есть»</button>
      <button onclick="markDefend('spray', '${route}')">Достать духи/дезодорант и держать как “спрей”</button>
    </div>
  `;
}

function markDefend(mode, route) {
  let text = "";
  let extra = "";

  if (mode === "shout") {
    text = "Вы начинаете кричать. Голос срывается, но громко. Мужики морщатся — им явно не нужна сцена.";
    extra = "Один из них шипит: “Тише ты…”";
  } else if (mode === "police") {
    text = "Вы поднимаете телефон и говорите вслух: “Да, мы в подъезде, двое мужчин мешают уйти…”";
    extra = "Они переглядываются. Улыбка исчезает.";
  } else if (mode === "neighbors") {
    text = "Вы специально говорите чётко и спокойно про камеры и соседей.";
    extra = "Парни на секунду тормозят — проверяют, не открылась ли где-то дверь.";
  } else {
    text = "Вы достаёте духи/дезик и держите как оружие. Это смешно — но работает: они не хотят лезть в лицо.";
    extra = "Один отшатывается: “Э, не психуй…”";
  }

  const exitBtn = route === "elevator"
    ? `<button onclick="markBreakAway('elevator')">Резко проскочить в лифт/к выходу</button>`
    : `<button onclick="markBreakAway('stairs')">Резко сорваться по лестнице вниз</button>`;

  game.innerHTML = `
    <h2>Подъезд</h2>
    <p>${escapeHtml(text)}</p>
    <p style="opacity:0.9;">${escapeHtml(extra)}</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Пока они на долю секунды растерялись, вы видите шанс.
      </p>
    </div>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
      ${exitBtn}
      <button onclick="markRunNow('${route}')">Не ждать — бежать прямо сейчас</button>
    </div>
  `;
}

function markBreakAway(route) {
  if (route === "elevator") {
    // здесь не “симулируем” реальный лифт, а делаем кинематографично
    game.innerHTML = `
      <h2>Подъезд</h2>
      <p>Вы срываетесь и уходите к выходу. Сзади звучит злое:</p>
      <p><strong>— Ну куда же вы!</strong></p>

      <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,120,120,0.08); border:1px solid rgba(255,120,120,0.20);">
        <p style="margin:0;">Шаги за спиной становятся ближе. Это уже не просто “шутка”.</p>
      </div>

      <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
        <button onclick="markChaseStreet()">Выскочить на улицу и не оглядываться</button>
      </div>
    `;
    return;
  }

  // stairs
  markChaseStairs();
}

// ====== ВАРИАНТ 2: они сразу бегут ======

function markRunNow(route) {
  // маршрут задаёт тон, но оба ведут к погоне
  if (route === "stairs") {
    markChaseStairs();
    return;
  }
  // elevator route -> тоже превращается в бег
  game.innerHTML = `
    <h2>Подъезд</h2>
    <p>Вы слышите, что они выходят — и понимаете: лифт не спасёт.</p>
    <p>Вы срываетесь и бежите вниз.</p>
    <button onclick="markChaseStairs()">Дальше</button>
  `;
}

function markChaseStairs() {
  game.innerHTML = `
    <h2>Погоня</h2>
    <p>Вы несётесь по лестнице. Сзади — тяжёлые шаги.</p>
    <p style="opacity:0.9;"><strong>— Эй! Стойте! Ну куда же вы!</strong></p>

    <p>Внизу развилка: можно выскочить во двор, или уйти через узкую арку.</p>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="markEscapeRoute('yard')">Во двор</button>
      <button onclick="markEscapeRoute('arch')">Через арку</button>
    </div>
  `;
}

function markEscapeRoute(path) {
  const text = path === "yard"
    ? "Вы вылетаете во двор. Ветер бьёт в лицо. Сзади ещё слышны крики — но вы уходите в сторону детской площадки и ныряете между домами."
    : "Вы ныряете в узкую арку. Там темно и пахнет сыростью. Вы слышите, как они ругаются — им неудобно бежать следом.";

  game.innerHTML = `
    <h2>Скрытый путь</h2>
    <p>${escapeHtml(text)}</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Через пару минут вы видите вывеску маленького магазинчика у дороги.
      </p>
    </div>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="markSafeShop()">Забежать в магазинчик</button>
    </div>
  `;
}

function markChaseStreet() {
  game.innerHTML = `
    <h2>На улице</h2>
    <p>Вы выскакиваете на улицу. Сердце колотится. За спиной — шаги.</p>
    <p>Девочки бегут и кричат друг другу: “Не останавливайтесь, нужно срочно найти какое-нибудь людное место!”</p>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="markEscapeRoute('arch')">Свернуть в арку</button>
      <button onclick="markEscapeRoute('yard')">Резко во двор</button>
    </div>
  `;
}

function markSafeShop() {
  // после Марка — по твоей логике мы возвращаемся к unlockPartyAfterFirstLocation (там откроется 80-е, если ещё не открыто)
  game.innerHTML = `
    <h2>Магазинчик</h2>
    <p>Вы влетаете внутрь. Звонит колокольчик над дверью.</p>
    <p>Продавец удивлённо смотрит, но вы быстро берёте воду и делаете вид, что вы просто запыхались.</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Вы переводите дыхание. Снаружи голоса стихли.
        <br> Всё. Сюда больше не возвращаемся.
      </p>
    </div>

    <p style="margin-top:12px; opacity:0.9;">Нужно решать, куда ехать дальше.</p>

    <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px; max-width:320px; margin-left:auto; margin-right:auto;">
      <button onclick="unlockPartyAfterFirstLocation()">Дальше</button>
    </div>
  `;
}
// ==================== МИНИ-ИГРА: ПРЕДМЕТЫ НА ВЕЧЕРИНКЕ 80-Х ====================

const PARTY80 = {
  found: new Set(),   // какие слова уже угадали
  lastMsg: ""         // последнее сообщение (успех/ошибка)
};

// Слово -> воспоминание
const party80Memories = {
  "стаканчик": "Вы вспомнили, как на кухне мешали импровизированный коктейль: водка, сок и лимон. Смеялись, пока не стало слишком громко.",
  "стакан": "Вы вспомнили, как на кухне мешали импровизированный коктейль: водка, сок и лимон.",
  "водка": "Вы вспомнили, что алкоголь был не только из бара — кто-то принёс бутылку и разливал по пластиковым стаканчикам.",
  "сок": "Вы вспомнили, что смешивали сок с чем-то крепким и называли это “коктейль 80-х”.",
  "лимон": "Вы вспомнили: кто-то резал лимон прямо на кухне и все спорили, кто “самый стойкий” и готов полностью его съесть.",
  "парик": "Вы вспомнили: видели этот парик на девушке и просили примерить. Смеялись, фоткались и кто-то кричал “диско!”.",
  "алиас": "Вы вспомнили, что играли в «Алиас» ночью: орали слова, перебивали друг друга. Кто-то явно жульничал.",
  "настольная игра": "Вы вспомнили, что играли в настольные игры, и это было очень шумно.",
  "настолки": "Вы вспомнили, что играли в настольные игры, и это было очень шумно.",
  "бутылка": "Вы вспомнили, как бутылки стояли рядком на столе — потом всё перемешалось.",
  "шторы": "Вы вспомнили: кто-то дёргал шторы, чтобы сделать “сцену”, включали музыку и изображали концерт.",
  "книги": "Вы вспомнили странный момент: кто-то полез в книжный шкаф и показывал старый альбом, как будто это важно."
};

function normWord(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[.,!?:;"'`()\[\]{}<>]/g, "");
}

function showParty80MemoryGame() {
  const foundList = Array.from(PARTY80.found);

  const msgHtml = PARTY80.lastMsg
    ? `
      <div style="margin-top:12px; padding:12px; border-radius:12px;
        background: rgba(255,120,120,0.08); border:1px solid rgba(255,120,120,0.20);">
        ${escapeHtml(PARTY80.lastMsg)}
      </div>
    `
    : "";

  const foundHtml = foundList.length
    ? `
      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
        ${foundList.map(k => `
          <div style="padding:12px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
            <strong>${escapeHtml(k)}</strong>
            <div style="margin-top:6px; opacity:0.95;">${escapeHtml(party80Memories[k])}</div>
          </div>
        `).join("")}
      </div>
    `
    : `<p style="opacity:0.85; margin-top:10px;">Пока ни одно воспоминание не всплыло. Попробуйте назвать предмет с картинки.</p>`;

  game.innerHTML = `
    <h2>Вечеринка 80-х</h2>
    <p>Квартира выглядит знакомо. Предметы вокруг как будто цепляют память…</p>

    <div style="margin-top:12px; text-align:center;">
      <img src="party80-scene.png"
     style="width:1000px; max-width:90%; height:auto;
            border-radius:14px;
            border:1px solid rgba(255,255,255,0.12);">
        Впиши предмет с картинки (например: мусор, диван…)
      </div>
    </div>

    ${msgHtml}

    <div style="margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <input id="party80Input" placeholder="Впиши предмет…" 
        style="width:min(420px, 90%); padding:12px 12px; border-radius:12px;
               background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.14);
               color: #fff; outline:none;">
      <button onclick="party80SubmitWord()">Проверить</button>
    </div>

    <div style="margin-top:16px;">
      <h3 style="margin-bottom:6px;">Найденные воспоминания</h3>
      ${foundHtml}
    </div>

    <div style="margin-top:18px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="showParty80WakeChoice()">Дальше: разбудить кого-то</button>
      <button onclick="showInvestigationHub()" style="opacity:0.85;">Назад</button>
    </div>
  `;

  const inp = document.getElementById("party80Input");
  if (inp) {
    inp.focus();
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") party80SubmitWord();
    });
  }
}

function party80SubmitWord() {
  const inp = document.getElementById("party80Input");
  const raw = inp ? inp.value : "";
  const word = normWord(raw);

  if (!word) {
    PARTY80.lastMsg = "Введите слово — предмет с картинки.";
    showParty80MemoryGame();
    return;
  }

  if (party80Memories[word]) {
    if (PARTY80.found.has(word)) {
      PARTY80.lastMsg = "Это вы уже вспоминали. Попробуйте другой предмет.";
    } else {
      PARTY80.found.add(word);
      PARTY80.lastMsg = "Воспоминание всплыло.";
    }
    showParty80MemoryGame();
    return;
  }

  PARTY80.lastMsg = "Этот предмет не разбудил в вас никаких воспоминаний.";
  showParty80MemoryGame();
}

function showParty80WakeChoice() {
  PARTY80.lastMsg = "";

  game.innerHTML = `
    <h2>Вечеринка 80-х</h2>
    <p>Вы осматриваетесь. Вокруг спят люди, музыка давно выключена.</p>
    <p style="opacity:0.9;">Кого разбудим?</p>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <button onclick="partyAsk('a')">Разбудить парня у стола (в наушниках)</button>
      <button onclick="partyAsk('b')">Разбудить девушку на диване (в парике)</button>
      <button onclick="partyAsk('c')">Разбудить человека на полу (еле дышит)</button>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <button onclick="showParty80MemoryGame()" style="opacity:0.9;">Назад к предметам</button>
      <button onclick="showInvestigationHub()" style="opacity:0.85;">К маршруту</button>
    </div>
  `;
}

// ==================== ВЕЧЕРИНКА 80-Х (база + выбор 3 людей) ====================

function startParty80() {
  setGameBackground("tysa80.png");
INVEST.visited.party80 = true;
  showParty80MemoryGame();
}

function partyAsk(who) {
  // 1) Пустой вариант: человек на полу
  if (who === "c") {
    game.innerHTML = `
      <h2>Вечеринка 80-х</h2>
      <p>Вы тормошите человека на полу. Он открывает глаза… и тут же снова закрывает.</p>
      <p style="opacity:0.9;">Никакой информации. Только невнятное мычание. Он живой и ладно.</p>

      <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px; max-width:320px; margin-left:auto; margin-right:auto;">
        <button onclick="showParty80WakeChoice()">Разбудить другого</button>
      </div>
    `;
    return;
  }

  // 2) Грубый парень
  if (who === "a") {
    const text = "Парень снимает наушники: «Что надо?? Я же сплю, не видно? Откуда мне знать, куда и когда вы уехали?»";

    game.innerHTML = `
      <h2>Вечеринка 80-х</h2>
      <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
        <p style="margin:0;">${escapeHtml(text)}</p>
      </div>

      <p style="margin-top:12px; opacity:0.9;">
        Неприятный тип, попробуйте разбудить другого.
      </p>

      <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px; max-width:320px; margin-left:auto; margin-right:auto;">
        <button onclick="showParty80WakeChoice()">Разбудить другого</button>
      </div>
    `;
    return;
  }

  // 3) Девушка даёт зацепку про парк
  if (who === "b") {
    const text = "Девушка в парике морщится: «О, привет! Да, вы тут были, а потом резко собрались и убежали.. кто-то сказал про парк аттракционов вроде.. но не знаю, как бы вы туда ночью попали.»";

    game.innerHTML = `
      <h2>Вечеринка 80-х</h2>
      <div style="margin-top:12px; padding:14px; border-radius:14px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
        <p style="margin:0;">${escapeHtml(text)}</p>
      </div>

      <p style="margin-top:12px; opacity:0.9;">
        Вам явно нужно посетить парк аттракционов.
      </p>

      <div style="margin-top:14px; display:flex; flex-direction:column; gap:10px; max-width:320px; margin-left:auto; margin-right:auto;">
        <button onclick="goAmusementPark()">Поехать в парк аттракционов</button>
        <button onclick="showParty80WakeChoice()" style="opacity:0.95;">Разбудить другого</button>
      </div>
    `;
    return;
  }
}
// ==================== УТИЛИТА ====================

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function goAmusementPark() {
  // стартуем с panorama0
  parkPanorama0();
}


// ==================== ПАРК АТТРАКЦИОНОВ: ПАНОРАМЫ + ХОВЕР-КНОПКИ ====================

// Вспомогательный рендер картинки (общая рамка)
function renderParkImage(imgName, innerHtml) {
setGameBackground("park-fon.png");  
return `
    <div style="margin-top:14px; text-align:center;">
      <div style="
        position:relative;
        display:inline-block;
        max-width:1100px;
        width:100%;
      ">
        <img src="${escapeHtml(imgName)}"
             style="width:100%; height:auto; border-radius:14px; border:1px solid rgba(255,255,255,0.12);">
        ${innerHtml || ""}
      </div>
    </div>
  `;
}

// Старт парка вызывается из вечеринки кнопкой "поехать в парк"
function goAmusementPark() {
  parkPanorama0();
}

// ---------- panorama0.png ----------
function parkPanorama0() {
  game.innerHTML = `
    <h2>Парк аттракционов</h2>
    <p style="opacity:0.9;">Днём тут спокойно, но чувство тревоги не уходит.</p>

    ${renderParkImage("panorama0.png", `
      <!-- Невидимая зона -> наводишь -> появляется кнопка -->
      <div class="hotspot" style="left:40%; top:40%; width:20%; height:20%;">
        <button class="hotspot-button" onclick="parkPanorama1()">Войти в парк</button>
      </div>
    `)}
  `;
}

// ---------- panorama1.png (центр) ----------
function parkPanorama1() {
  game.innerHTML = `
    <h2>Центр парка</h2>
    <p style="opacity:0.9;">Вы стоите у карусели. Куда пойти и что осмотреть?</p>

    ${renderParkImage("panorama1.png", `
      <!-- HOTSPOT: осмотреть карусель -->
      <div class="hotspot" style="left:38%; top:28%; width:26%; height:38%;">
        <button class="hotspot-button" onclick="parkInspectCarousel()">Осмотреть карусель</button>
      </div>

      <!-- HOTSPOT: пойти влево -->
      <div class="hotspot" style="left:8%; top:55%; width:18%; height:22%;">
        <button class="hotspot-button" onclick="parkPanorama1Left()">Пойти влево</button>
      </div>

      <!-- HOTSPOT: пойти вправо -->
      <div class="hotspot" style="left:74%; top:55%; width:18%; height:22%;">
        <button class="hotspot-button" onclick="parkPanorama1Right()">Пойти вправо</button>
      </div>
    `)}
  `;
}

function parkInspectCarousel() {
  game.innerHTML = `
    <h2>Карусель</h2>
    <p>Вы подходите ближе и осматриваете детали.</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Карусель выглядит как обычно. Но вы тут явно были. На одной из лошадок вы нашли бусинки с макияжа Кати, совпадение ли это? В вас просыпаются воспоминания о том, как вы дурачились здесь и делали фото.     </p>
    </div>

   <!-- КАРТИНКА -->
    <div style="margin-top:18px; text-align:center;">
      <img
        src="attraction.png"
        alt="Карусель в парке"
        style="
          width:100%;
          max-width:860px;
          height:auto;
          display:block;
          margin:0 auto;
          border-radius:14px;
          border:1px solid rgba(255,255,255,0.14);
          box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        "
      >
    </div>

    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama1()">Назад</button>
    </div>
  `;
}

// ---------- panorama1-2.png (лево) ----------
function parkPanorama1Left() {
  game.innerHTML = `
    <h2>Левая часть парка</h2>
    <p style="opacity:0.9;">Тут тише. Можно осмотреться внимательнее.</p>

    ${renderParkImage("panorama1-2.png", `
      <!-- HOTSPOT: осмотреть скамейку -->
      <div class="hotspot" style="left:10%; top:70%; width:22%; height:18%;">
        <button class="hotspot-button" onclick="parkInspectBench()">Осмотреть скамейку</button>
      </div>

      <!-- HOTSPOT: вернуться -->
      <div class="hotspot" style="left:78%; top:70%; width:18%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama1()">Назад</button>
      </div>
    `)}
  `;
}

function parkInspectBench() {
  game.innerHTML = `
    <h2>Скамейка</h2>
    <p>Вы осматриваете скамейку и землю вокруг.</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        На скамейке найден мусор и игрушка ребенка. Ничего, что могло бы вам помочь.
      </p>
    </div>
<!-- ФОТО ПОД ДИАЛОГОМ (замени src на свой файл) -->
      <div style="margin-top:12px; text-align:center;">
        <img src="scameika.png"
             style="max-width:600px; width:100%; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);">
      </div>

    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama1Left()">Назад</button>
    </div>
  `;
}

// ---------- panorama1-3.png (право: касса) ----------
function parkPanorama1Right() {
  game.innerHTML = `
    <h2>Правая часть парка</h2>
    <p style="opacity:0.9;">Здесь касса и проход дальше по тропинке.</p>

    ${renderParkImage("panorama1-3.png", `
      <!-- HOTSPOT: поговорить с кассиром -->
      <div class="hotspot" style="left:46%; top:36%; width:22%; height:28%;">
        <button class="hotspot-button" onclick="parkTalkCashier()">Поговорить с кассиром</button>
      </div>

      <!-- HOTSPOT: дальше по тропинке -->
      <div class="hotspot" style="left:5%; top:50%; width:22%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama2_1()">Пойти дальше</button>
      </div>

      <!-- HOTSPOT: назад -->
      <div class="hotspot" style="left:8%; top:70%; width:18%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama1()">Назад</button>
      </div>
    `)}
  `;
}

function parkTalkCashier() {
  game.innerHTML = `
    <h2>Касса</h2>
    <p><strong>Вы:</strong> «Добрый день! Подскажите пожалуйста, мы вчера вроде здесь были, вы нас не помните?»</p>
    <p><strong>Кассир:</strong> «Здравствуйте. Не-а… У меня тут столько людей проходят, почему я должна была вас запомнить?»</p>
    <p style="opacity:0.9;">Похоже, она искренне не в курсе. Следа нет.</p>
<!-- ФОТО ПОД ДИАЛОГОМ (замени src на свой файл) -->
    <div style="margin-top:12px; text-align:center;">
      <img src="panoramakassa.png"
           style="max-width:600px; width:100%; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);">
    </div>
    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama1Right()">Вернуться</button>
    </div>
  `;
}

// ---------- panorama2-1.png (камера) ----------
function parkPanorama2_1() {
  game.innerHTML = `
    <h2>Глубже в парке</h2>
    <p style="opacity:0.9;">Дорожка уходит дальше.</p>

    ${renderParkImage("panorama2-1.png", `
      <!-- HOTSPOT: камера -->
      <div class="hotspot" style="left:85%; top:10%; width:16%; height:20%;">
        <button class="hotspot-button" onclick="parkInspectCamera()">Осмотреть камеру</button>
      </div>
<!-- HOTSPOT: продавец сахарной ваты -->
  <div class="hotspot" style="left:53%; top:30%; width:20%; height:28%;">
    <button class="hotspot-button" onclick="parkTalkCottonCandy()">Поговорить с продавцом</button>
  </div>
      <!-- HOTSPOT: пойти вправо -->
      <div class="hotspot" style="left:78%; top:70%; width:18%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama2_2()">Пойти вправо</button>
      </div>

      <!-- HOTSPOT: назад -->
      <div class="hotspot" style="left:8%; top:70%; width:18%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama1Right()">Назад</button>
      </div>
    `)}
  `;
}

function parkInspectCamera() {
  game.innerHTML = `
    <h2>Камера</h2>
    <p>Камера направлена на тропинку и часть площади.</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Похоже, камера работает. Значит, записи могли сохраниться.
        Доступ к ним, скорее всего, только у охраны.
      </p>
<!-- ФОТО ПОД ДИАЛОГОМ (замени src на свой файл) -->
    <div style="margin-top:12px; text-align:center;">
      <img src="kamera.png"
           style="max-width:600px; width:100%; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);">
    </div>

    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama2_1()">Назад</button>
    </div>
  `;
}

// ---------- panorama2-2.png (урна + будка охраны) ----------
const GUARD = {
  attempts: 0,
  bribed: false,
  alcoholRoute: false,
  hasKeyInfo: false
};
function parkPanorama2_2() {
  game.innerHTML = `
    <h2>Будка охраны</h2>
    <p style="opacity:0.9;">Вы видите будку. Самое время попробовать поговорить.</p>

    ${renderParkImage("panorama2-2.png", `
      <!-- HOTSPOT: урна -->
      <div class="hotspot" style="left:30%; top:45%; width:14%; height:18%;">
        <button class="hotspot-button" onclick="parkInspectBin()">Осмотреть урну</button>
      </div>

      ${PARK.inspectedBin ? `
  <div class="hotspot" style="left:45%; top:25%; width:24%; height:40%;">
    <button class="hotspot-button" onclick="startGuardTalk()">Подойти к охране</button>
  </div>
` : ``}

      <!-- HOTSPOT: назад -->
      <div class="hotspot" style="left:8%; top:70%; width:18%; height:18%;">
        <button class="hotspot-button" onclick="parkPanorama2_1()">Назад</button>
      </div>
    `)}
  `;
}

function parkInspectBin() {
  PARK.inspectedBin = true;
game.innerHTML = `
    <h2>Урна</h2>
    <p>Внутри — стаканчики, обёртки, мелкий мусор.</p>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">
        Вы видите до боли знакомые стаканчики и "дудки-язычки" , очень похожи на те, которые были на вечеринке в стиле 80х. Значит, вы точно тут были. А также видно, что тут 5 комплектов стаканов и 5шт язычков, скорее всего, Вита была в этот момент с вами.
      </p>
    </div>
<!-- ФОТО ПОД ДИАЛОГОМ (замени src на свой файл) -->
    <div style="margin-top:12px; text-align:center;">
      <img src="urna.png"
           style="max-width:420px; width:100%; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);">
    </div>

    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama2_2()">Назад</button>
    </div>
  `;
}

// Заглушка — следующий шаг: мини-игра "уговорить сторожа"
function startGuardTalk() {
  game.innerHTML = `
    <h2>Будка охраны</h2>

    <div style="
      display:flex;
      gap:40px;
      align-items:flex-start;
      margin-top:18px;
      flex-wrap:wrap;
    ">

      <!-- ЛЕВАЯ ЧАСТЬ — ТЕКСТ -->
      <div style="flex:1; min-width:320px;">
        <div style="
          padding:16px;
          border-radius:14px;
          background: rgba(255,255,255,0.06);
          border:1px solid rgba(255,255,255,0.12);
        ">
          <p>В будке темно. Телевизор тихо шипит.</p>
          <p><strong>Охранник</strong> медленно поворачивается к вам.</p>

          <p style="margin-top:10px;"><strong>Охранник:</strong> «Касса в другой стороне.»</p>

          <p><strong>Вы:</strong> «Мы к вам. Мы ищем подругу. Она могла быть здесь ночью.»</p>

          <p style="opacity:0.9;">Он долго смотрит на вас. Не мигая.</p>

          <p><strong>Охранник:</strong> «Ночью? А что приличным людям делать в парке ночью?»</p>
        </div>

        <h3 style="margin-top:16px;">Как отвечаете?</h3>

        <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px; max-width:720px;">
          <button onclick="guardBranch('deny')">«Нам просто сказали, что нашу подругу тут видели. Мы переживаем за нее»</button>
          <button onclick="guardBranch('pressure')">«Вы обязаны рассказать, что произошло.»</button>
        </div>

        <div style="margin-top:14px;">
          <button onclick="parkPanorama2_2()" style="opacity:0.85;">Назад</button>
        </div>
      </div>

      <!-- ПРАВАЯ ЧАСТЬ — ФОТО -->
     <div style="flex:1; min-width:320px; display:flex; align-items:flex-start; justify-content:center;">
        <img src="ohrana.png"
             style="
               width:100%;
               height:auto;
               border-radius:14px;
               border:1px solid rgba(255,255,255,0.12);
               box-shadow:0 0 25px rgba(0,0,0,0.5);
             ">
      </div>

    </div>
  `;
}


function guardBranch(type) {

  // Давление — он закрывается
  if (type === "pressure") {
    game.innerHTML = `
      <h2>Будка охраны</h2>

      <div style="margin-top:12px; padding:16px; border-radius:14px;
        background: rgba(255,120,120,0.10);
        border:1px solid rgba(255,120,120,0.22);">

        <p><strong>Охранник:</strong> «Я вам ничего не обязан.»</p>
        <p>«Ночью тут нарушители были, перелезли через забор, вандалы! Прыгали на нерабочих аттракицонах.»</p>
        <p>«Алкашня обычная, им скучно, а я выговор получай. Вообще, валите отсюда, что пристали? Вас это не касается! Или тоже в полицию хотите?»</p>

        <p style="opacity:0.9;">
          Ой, кажется мы нарываемся. Ночью явно были мы.. нужно узнать больше.
        </p>
      </div>

      <div style="margin-top:16px; display:flex; justify-content:center; gap:10px;">
        <button onclick="guardTryBribe()">Попробовать смягчить разговор</button>
      </div>
    `;
    return;
  }

  // Отрицание — он начинает вспоминать
  if (type === "deny") {
    game.innerHTML = `
      <h2>Будка охраны</h2>

      <div style="margin-top:12px; padding:16px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);">

        <p><strong>Охранник:</strong> «Может и видели.»</p>
        <p>«А может и ваша подруга была ночью, я то откуда знаю. Ночью сегодня вообще девушки бегали, одна даже с простыней на голове вроде была, неадекватная.»</p>
        <p>«Такие весёлые были, бегали от меня.. Пока я не вызвал ЧОП, вот потом им не до смеха было.»</p>

        <p style="opacity:0.9;">
          Он внимательно смотрит на вас.
        </p>
      </div>

      <div style="margin-top:16px; text-align:center;">
        <button onclick="guardDeepen()">А во сколько это было? Можете чуть подробнее рассказать</button>
      </div>
    `;
    return;
  }

  // Переживание — он говорит больше
  if (type === "concern") {
    guardDeepen();
  }
}
function guardDeepen() {
  game.innerHTML = `
    <h2>Будка охраны</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Охранник:</strong></p>

      <p>«Около четырёх утра это было.»</p>
      <p>«Бегали, развлекались, от меня прятались. До тех пор пока не включились фонари и ЧОП не выскочил. Свист, крики. Паника.»</p>

      <p>«Они разбежались по сторонам.»</p>

      <p style="opacity:0.9;">
        Он делает паузу.
      </p>

      <p>«Одну в темноте схватили.»</p>
      <p>«Остальные, похоже, даже внимания на подругу не обратили и сбежали куда-то.»</p>
<p><strong>Вы:</strong> «А куда ее увезли?.»</p>
    <p><strong>Охранник:</strong> «Это уже не ваше дело»</p>

</div>

    <h3 style="margin-top:16px;">Что делаем дальше?</h3>

    <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px; max-width:720px;">
      <button onclick="guardTryBribe()">«Отойти обсудить дальнейшие действия »</button>
          </div>
  `;
}
function guardFinalReveal() {
  game.innerHTML = `
    <h2>Будка охраны</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Охранник:</strong></p>

      <p>«Та, что отстала.»</p>
      <p>«ЧОПовцы её взяли. Я думал — вместе всех оформят.»</p>
      <p>«А остальные уже за территорией были.»</p>
<p>«Пока добежал до них, увидел только, что простыня той самой в такси заскочила и они сразу же уехали.»</p>

      <p style="margin-top:12px;"><strong>Охранник</strong> прищуривается:</p>

      <p>«А вы…»</p>
      <p>«Вы даже чем-то их напоминаете.»</p>
      <p>«Ночью плохо видно было…»</p>
      <p>«Это случайно были не вы?»</p>
    </div>

    <div style="margin-top:16px; display:flex; flex-direction:column; gap:10px; max-width:720px;">
      <button onclick="guardDeny()">«Ой, нееет! Мы таким не занимаемся.. но, к сожалению, там была наша подруга. Она связалась с плохой компанией…»</button>
      <button onclick="guardDeny()">«Вы что, мы вообще не такие!»</button>
    </div>
  `;
}
function guardDeny() {
  game.innerHTML = `
    <h2>Будка охраны</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Вы:</strong> «Нет-нет, вы ошиблись. Там была наша подруга. Мы её ищем.»</p>

      <p><strong>Охранник</strong> смотрит ещё пару секунд.</p>

      <p>«Может быть.»</p>
      <p>«Но если она была среди них — её забрал ЧОП.»</p>
      <p>«А дальше уже не моя зона.»</p>
    </div>

    <div style="margin-top:16px; text-align:center;">
      <button onclick="afterGuardInfo()">Отойти от будки</button>
    </div>
  `;
}

function guardTryBribe() {
  game.innerHTML = `
    <h2>Как его задобрить?</h2>
    <p style="opacity:0.9;">Нужно его угостить чем-нибудь, так наверное больше информации получим.. что купим?</p>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-width:520px;">
      <button onclick="guardBribe('cognac')">Купить коньяк</button>
      <button onclick="guardBribe('candy')">Купить дорогую коробку конфет</button>
    </div>
  `;
}

function guardBribe(kind) {
  // Ветка "коньяк" — он закодирован и орёт -> потом только конфеты
  if (kind === "cognac") {
    GUARD.alcoholRoute = true;

    game.innerHTML = `
      <h2>Будка охраны</h2>
      <div style="margin-top:12px; padding:14px; border-radius:14px;
        background: rgba(255,120,120,0.10);
        border:1px solid rgba(255,120,120,0.22);">

        <p><strong>Вы</strong> протягиваете пакет.</p>
        <p><strong>Охранник</strong> заглядывает внутрь — и его лицо резко меняется.</p>

        <p><strong>Охранник:</strong> «Вы что творите?! Я закодирован!»</p>
        <p>«Мне здоровье угробить решили? Идите отсюда, пока я вас сам не вывел!»</p>

        <p style="opacity:0.9;">Он злится по-настоящему теперь. Надо было начать с конфет, придется еще и конфеты покупать.</p>
      </div>

      <div style="margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <button onclick="guardSecondChanceAfterFail()">Попробовать по-другому</button>
      </div>
    `;
    return;
  }

  // Ветка "конфеты" — успех, он раскрывается
  if (kind === "candy") {
    GUARD.bribed = true;
    GUARD.hasKeyInfo = true;

    game.innerHTML = `
      <h2>Будка охраны</h2>
      <div style="margin-top:12px; padding:14px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);">

        <p><strong>Охранник</strong> берёт коробку, читает название, и уголок рта дёргается.</p>
        <p><strong>Охранник:</strong> «Ну… вот это другое дело. Ладно.»</p>
        <p>«Что вам так интересно?»</p>

        <p style="opacity:0.9;">Похоже, теперь он готов говорить.</p>
      </div>

      <div style="margin-top:16px; text-align:center;">
        <button onclick="guardFullConfessionIntro()">Слушать</button>
      </div>
    `;
    return;
  }
}

function guardSecondChanceAfterFail() {
  game.innerHTML = `
    <h2>Как исправиться?</h2>
    <p style="opacity:0.9;">Похоже, алкоголь — мимо. Нужно что-то другое.</p>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px; max-width:520px;">
      <button onclick="guardBribe('candy')">Купить дорогую коробку конфет</button>
    </div>
  `;
}
function guardFullConfessionIntro() {
  GUARD.hasKeyInfo = true;

  game.innerHTML = `
    <h2>Будка охраны</h2>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Охранник:</strong> «Ладно. Только без надоедливых вопросов, все что знаю - говорю.»</p>
      <p><strong>Вы:</strong> «Мы просто хотим знать, где она…»</p>

      <p style="margin-top:10px;"><strong>Охранник</strong> тяжело вздыхает и вспоминает:</p>

      <p>«Ночью сюда часто лезут. Думают — парк пустой, значит можно всё. Вчера тоже — шум, визг, беготня. Я вышел — вижу: компания девушек, явно выпившие.»</p>
      <p>«Я свистнул, сказал: “Девочки, объясняем, что тут делаем”. Они сначала смеются, а потом как драпу дали!<p>
      <p>«Ну, я за ними, пол парка отбегали с ними, пока я не психанул и не вызвал ЧОП, те, ребята молодые, в отличие от меня, почти сразу поймали одну девушку, пока другие через забор перелазили.»</p>
 <p>«Ну и все, пытался помочь им, догнать других, но без толку, они успели в такси сесть и уехать. А ту девушку повязали и забрали в ближайшее отсюда отделение полиции.»</p>
    
    </div>

    <div style="margin-top:16px; text-align:center;">
      <button onclick="afterGuardInfo()" style="opacity:0.85;">Отойти обсудить</button>
    </div>
  `;
}

function afterGuardInfo() {
  game.innerHTML = `
    <h2>Снаружи</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p>Вы отходите от будки. Теперь ясно одно: скорее всего Виту увезли в отделение полиции.</p>

      <p style="margin-top:10px;">
        Нужно решать. Нужно срочно ехать к ней. Но куда же поехать?
      </p>

      <p style="margin-top:10px; opacity:0.95;">
        Мы находимся на улице <strong>Кузнецовская 25Б</strong> в <strong>Гагарин-парке</strong>
      </p>

      <div style="margin-top:12px; opacity:0.95; line-height:1.55;">
        <div><strong>Отдел полиции №29</strong> — ул. Варшавская 37к3</div>
        <div><strong>Отдел полиции №33</strong> — ул. Космонавтов 21к3</div>
        <div><strong>Участковый пункт полиции 17</strong> — проспект Юрия Гагарина 12к2</div>
        <div><strong>Участковый пункт полиции 11</strong> — ул. Московский проспект 159</div>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; flex-direction:column; gap:10px; max-width:520px;">
      <button onclick="policePick('p29')">Отдел полиции № 29</button>
      <button onclick="policePick('p33')">Отдел полиции № 33</button>
      <button onclick="policePick('u17')">Участковый пункт полиции 17</button>
      <button onclick="policePick('u11')">Участковый пункт полиции 11</button>
    </div>

    <div style="margin-top:16px;">
      <button onclick="parkPanorama2_2()" style="opacity:0.85;">Назад в парк</button>
    </div>
  `;
}

function policePick(choice) {
setGameBackground("police.png");  
POLICE.lastChoice = choice;

  // правильный
  if (choice === "p33") {
    policeSuccess();
    return;
  }

  // неправильный -> ставим блок 2:00
  POLICE.lockUntil = Date.now() + 2 * 60 * 1000;

  if (choice === "u17" || choice === "u11") {
    policeWrongPrecinct(choice);
  } else {
    policeWrongStation(choice);
  }
}

// --- Неправильный отдел полиции ---
function policeWrongStation(choice) {
setGameBackground("police.png");  
  const pickedName = choice === "p29"
    ? "Отдел полиции №29"
    : "Отдел полиции";

  game.innerHTML = `
    <h2>Вы не туда приехали</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,120,120,0.10);
      border:1px solid rgba(255,120,120,0.22);">

      <p><strong>К сожалению, этот пункт оказался не ближайшим.</strong></p>
      <p style="opacity:0.9;">Вы потратили время на дорогу и разговоры, а теперь нужно возвращаться и выбирать заново.</p>
    </div>

    ${policeRetryPanel()}
  `;

  startPoliceRetryTimer();
}

// --- Неправильный участковый пункт ---
function policeWrongPrecinct(choice) {
setGameBackground("police.png");  
  const pickedName = choice === "u17"
    ? "Участковый пункт полиции 17"
    : "Участковый пункт полиции 11";

  game.innerHTML = `
    <h2>Участковый пункт</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,120,120,0.10);
      border:1px solid rgba(255,120,120,0.22);">

      <p><strong>После того, как вы пришли в участковый пункт, полицейский сообщил:</strong></p>
      <p>«На задержание людей ночью привозят в <strong>отдел полиции</strong>, а не к участковому.»</p>

      <p style="margin-top:10px; opacity:0.9;">
        Так как вы пришли не туда, дорога назад занимает больше времени. Подумайте ещё раз, куда дальше ехать…
      </p>
    </div>

    ${policeRetryPanel()}
  `;

  startPoliceRetryTimer();
}

// --- Общий блок с вопросом + таймером + кнопкой (заблокирована) ---
function policeRetryPanel() {
setGameBackground("police.png");  
  return `
    <div style="margin-top:14px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p style="margin-top:0; opacity:0.95;">
        Мы находились на улице <strong>Кузнецовская 25Б</strong> в <strong>Гагарин-парке</strong>, в какое отделение нужно ехать?
      </p>

      <div style="margin-top:10px; opacity:0.95; line-height:1.55;">
        <div><strong>Отдел полиции № 29</strong> — ул. Варшавская 37к3</div>
        <div><strong>Отдел полиции № 33</strong> — ул. Космонавтов 21к3</div>
        <div><strong>Участковый пункт полиции 17</strong> — проспект Юрия Гагарина 12к2</div>
        <div><strong>Участковый пункт полиции 11</strong> — ул. Московский проспект 159</div>
      </div>

      <div style="margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div style="opacity:0.9;">
          Можно выбрать другой пункт через: <strong id="policeTimer">02:00</strong>
        </div>

        <button id="policeRetryBtn" onclick="afterGuardInfo()" disabled style="opacity:0.55; cursor:not-allowed;">
          Выбрать другой пункт
        </button>
      </div>
    </div>
  `;
}

// --- Таймер 2:00: обновляет текст и включает кнопку ---
function startPoliceRetryTimer() {
  const timerEl = document.getElementById("policeTimer");
  const btnEl = document.getElementById("policeRetryBtn");

  function tick() {
    const msLeft = Math.max(0, POLICE.lockUntil - Date.now());
    const totalSec = Math.ceil(msLeft / 1000);

    const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
    const ss = String(totalSec % 60).padStart(2, "0");

    if (timerEl) timerEl.textContent = `${mm}:${ss}`;

    if (msLeft <= 0) {
      if (btnEl) {
        btnEl.disabled = false;
        btnEl.style.opacity = "1";
        btnEl.style.cursor = "pointer";
      }
      return; // стоп
    }

    setTimeout(tick, 250);
  }

  tick();
}

// --- Успех: правильный отдел № 33 ---
function policeSuccess() {
setGameBackground("police.png");  
  game.innerHTML = `
    <h2>Отдел полиции №33</h2>

    <div style="
      display:flex;
      gap:40px;
      align-items:stretch;
      margin-top:20px;
      flex-wrap:wrap;
    ">

      <!-- ЛЕВАЯ ЧАСТЬ — ТЕКСТ -->
      <div style="flex:1; min-width:320px;">
        <div style="
          padding:20px;
          border-radius:14px;
          background: rgba(255,255,255,0.06);
          border:1px solid rgba(255,255,255,0.12);
        ">
          <p><strong>Вы выбираете ближайший отдел.</strong></p>

          <p style="margin-top:10px;">
            Логично. Именно сюда ночью обычно привозят задержанных.
          </p>

          <p style="margin-top:10px; opacity:0.9;">
            Машина останавливается у серого здания.
            Свет в окнах холодный.
            Внутри кто-то двигается.
          </p>

          <p style="margin-top:10px; opacity:0.9;">
            Сердце начинает биться быстрее.
            Все замерли. Даже дыхание стало тише. Каждый молится, чтобы Вита была именно здесь — и чтобы с ней всё было в порядке. Чтобы она не пострадала. И чтобы их глупый побег не стал для неё предательством.
          </p>
        </div>

        <div style="margin-top:18px; display:flex; gap:10px; flex-wrap:wrap;">
          <button onclick="policeCorridor1()">Войти внутрь</button>
          </button>
        </div>
      </div>

      <!-- ПРАВАЯ ЧАСТЬ — ФОТО -->
      <div style="
        flex:1;
        min-width:320px;
        position:relative;
        overflow:hidden;
        border-radius:14px;
      ">
        <img src="poliza.png"
             style="
               width:100%;
               height:100%;
               object-fit:cover;
               border-radius:14px;
               animation: policeZoom 6s ease-in-out infinite alternate;
               filter: brightness(0.75) contrast(1.1);
             ">

        <!-- Тёмный градиент сверху для драматичности -->
        <div style="
          position:absolute;
          inset:0;
          background: linear-gradient(
            to bottom,
            rgba(0,0,0,0.5),
            rgba(0,0,0,0.2),
            rgba(0,0,0,0.6)
          );
          pointer-events:none;
        "></div>
      </div>

    </div>

    <style>
      @keyframes policeZoom {
        from {
          transform: scale(1);
        }
        to {
          transform: scale(1.05);
        }
      }
    </style>
  `;
}
// -------------------- Обход парка --------------------
function searchPark() {
    game.innerHTML = `
        <h2>Обход парка</h2>
        <p>Вы обошли весь парк вокруг и ничего не нашли, не вспомнили, только устали.</p>
        <button onclick="goToCathedral()">Вернуться назад к другому действию</button>
    `;
}

function openDevMenu() {
  game.innerHTML = `
    <h2>Тест-меню (DEV)</h2>
    <p style="opacity:0.85;">Быстрый переход на нужную сцену.</p>

    <div style="display:flex; flex-direction:column; gap:10px; max-width:360px;">

      <strong>Парк:</strong>
      <button onclick="parkPanorama0()">panorama0 (вход)</button>
      <button onclick="parkPanorama1()">panorama1 (центр)</button>
      <button onclick="parkPanorama1Left()">panorama1-2 (лево)</button>
      <button onclick="parkPanorama1Right()">panorama1-3 (право/касса)</button>
      <button onclick="parkPanorama2_1()">panorama2-1 (камера)</button>
      <button onclick="parkPanorama2_2()">panorama2-2 (охрана/урна)</button>

      <hr style="opacity:0.2; margin:10px 0;">

      <strong>Полиция:</strong>
      <button onclick="policeCorridor1()">Полиция: вход в коридор</button>
      <button onclick="startInterrogation()">Полиция: дежурная часть</button>

    </div>

    <div style="margin-top:16px;">
      <button onclick="showInvestigationHub()" style="opacity:0.85;">Назад</button>
    </div>
  `;
}
function parkTalkCottonCandy() {
  game.innerHTML = `
    <h2>Продавец сахарной ваты</h2>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Вы:</strong> «Добрый день! Подскажите, вы вчера тут работали?»</p>

      <p><strong>Продавец:</strong> «Добрый день, милые девушки! К сожалению, вчера был мой выходной. Вы хотели сахарную вату попробовать?.»</p>
<p><strong>Вы:</strong> «Да нет, спасибо, в следующий раз обязательно.»</p>

      <p style="opacity:0.9;">
        Он нам не поможет.. Надо еще подумать
      </p>
    </div>
<!-- ФОТО ПОД ДИАЛОГОМ (замени src на свой файл) -->
      <div style="margin-top:12px; text-align:center;">
        <img src="panoramavata.png"
             style="max-width:600px; width:100%; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);">
      </div>
    </div>
    <div style="margin-top:18px; text-align:center;">
      <button onclick="parkPanorama2_1()">Вернуться</button>
    </div>
  `;
}
// ===== ЭТАП 1: Коридор отдела (фонарик + двери) =====

// ==================== POLICE CORRIDOR (3 scenes + flashlight + door hints) ====================

function enableFlashlight(containerId) {
setGameBackground("police.png");
  const el = document.getElementById(containerId);
  if (!el) return;

  const move = (e) => {
    const r = el.getBoundingClientRect();
    const x = ((e.clientX - r.left) / r.width) * 100;
    const y = ((e.clientY - r.top) / r.height) * 100;
    el.style.setProperty("--fx", x + "%");
    el.style.setProperty("--fy", y + "%");
  };

  el.style.setProperty("--fx", "50%");
  el.style.setProperty("--fy", "50%");
  el.addEventListener("mousemove", move);
}

function renderPoliceImage(containerId, src, hotspotsHTML) {
  return `
    <div id="${containerId}" style="position:relative; max-width:1200px; margin:0 auto;">
      <img src="${src}" style="width:100%; border-radius:16px; display:block; border:1px solid rgba(255,255,255,0.12);">
      <div class="flashlight-overlay"></div>
      ${hotspotsHTML || ""}
    </div>
  `;
}

// ---------- Door hint pages ----------
 function openPoliceDoor(code, backFnName) {
  // Поставь здесь свои файлы:
  const images = {
    SP: "komnata.png",        // служебное помещение
    T:  "tyalett.png",    // туалет
    A:  "arhive.png",   // архив
    K:  "komp.png",   // камеры
    KD: "dopros.png",        // комната досмотра / круглый стол
    DCH:"glavnai.png"        // дежурная часть
  };

  const data = {
    SP: {
      title: "С.п.",
      text: "Служебное помещение: коробки, инвентарь, ведомости. Тут никого не держат и не оформляют."
    },
    T: {
      title: "Т.",
      text: "Служебный туалет. Запах хлорки, мерцающий свет. Явно не то место."
    },
    A: {
      title: "А.",
      text: "Архив. Стеллажи с папками до потолка. Ворчливая сотрудница: «Вы кто такие?? Это архив. Тут только сотрудники. Вам явно не сюда.»"
    },
    K: {
      title: "К.",
      text: "Комната с компьютерами и мониторами. Камеры наблюдения. Но задержанных сюда не приводят."
    },
    KD: {
      title: "К.д.",
      text: "Комната досмотра. Холодно и неприятно. Это место для процедур, а не для поисков."
    },
    DCH: {
      title: "Д.ч.",
      text: "Дежурная часть. Слышны голоса и рация. Кажется, вы наконец близко."
    }
  };

  const info = data[code] || { title: "Дверь", text: "Пусто." };
  const img = images[code]; // может быть undefined — тогда просто не покажем картинку
  const backCall = backFnName ? `${backFnName}()` : `policeCorridor2()`;

  const extraBtn = (code === "DCH")
    ? `<button onclick="enterDutyOffice()">Войти внутрь</button>`
    : "";

  // уникальный id, чтобы фонарик включился именно тут
  const wrapId = `room_${code}_${Date.now()}`;

  game.innerHTML = `
    <h2>${escapeHtml(info.title)}</h2>

    <div style="margin-top:12px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">
      <p style="margin:0;">${escapeHtml(info.text)}</p>
    </div>

    ${img ? renderFlashlightImage(wrapId, img) : ""}

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      ${extraBtn}
      <button onclick="${backCall}" style="opacity:0.9;">Назад</button>
    </div>
  `;

  if (img) enableFlashlight(wrapId);
} 

// ---------- Scene 1 ----------
function policeCorridor1() {
  game.innerHTML = `
    <h2>Коридор отдела</h2>
    <p style="opacity:0.9;">Тусклый свет, тишина. Вы заходите внутрь.</p>

    ${renderPoliceImage("corr1", "corridor1.png", `
      <div class="hotspot" style="left:8%; top:55%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('SP','policeCorridor1')">1.С.п.</button>
      </div>

      <div class="hotspot" style="left:74%; top:55%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('T','policeCorridor1')">2.Т</button>
      </div>

      <div class="hotspot" style="left:45%; top:47%; width:20%; height:25%;">
        <button class="hotspot-button" onclick="policeCorridor2()">Идти дальше</button>
      </div>
    `)}
  `;
  enableFlashlight("corr1");
}

// ---------- Scene 2 ----------
function policeCorridor2() {
  game.innerHTML = `
    <h2>Глубже в отделе</h2>
    <p style="opacity:0.9;">Здесь уже слышны голоса. Но какая дверь нужная?</p>

    ${renderPoliceImage("corr2", "corridor2.png", `
      <div class="hotspot" style="left:8%; top:35%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('DCH','policeCorridor2')">3.Д.ч.</button>
      </div>

      <div class="hotspot" style="left:74%; top:35%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('KD','policeCorridor2')">4.К.д.</button>
      </div>

      <div class="hotspot" style="left:40%; top:75%; width:20%; height:20%;">
        <button class="hotspot-button" onclick="policeCorridor1()">Назад</button>
      </div>

      <div class="hotspot" style="left:40%; top:48%; width:20%; height:20%;">
        <button class="hotspot-button" onclick="policeCorridor3()">Вперёд</button>
      </div>
    `)}
  `;
  enableFlashlight("corr2");
}

// ---------- Scene 3 ----------
function policeCorridor3() {
  game.innerHTML = `
    <h2>Конец коридора</h2>
    <p style="opacity:0.9;">Пахнет бумагой и пылью. Не похоже на место для задержанных.</p>

    ${renderPoliceImage("corr3", "corridor3.png", `
      <div class="hotspot" style="left:8%; top:35%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('A','policeCorridor3')">5.А</button>
      </div>

      <div class="hotspot" style="left:74%; top:35%; width:18%; height:45%;">
        <button class="hotspot-button" onclick="openPoliceDoor('K','policeCorridor3')">6.К</button>
      </div>

      <div class="hotspot" style="left:40%; top:75%; width:20%; height:20%;">
        <button class="hotspot-button" onclick="policeCorridor2()">Назад</button>
      </div>
    `)}
  `;
  enableFlashlight("corr3");
}

// ---------- Correct door next step (your next stage) ----------
function enterDutyOffice() {
  startInterrogation();
}
// ===== Flashlight helpers (для комнат тоже) =====
function enableFlashlight(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;

  const move = (e) => {
    const r = el.getBoundingClientRect();
    const x = ((e.clientX - r.left) / r.width) * 100;
    const y = ((e.clientY - r.top) / r.height) * 100;
    el.style.setProperty("--fx", x + "%");
    el.style.setProperty("--fy", y + "%");
  };

  el.style.setProperty("--fx", "50%");
  el.style.setProperty("--fy", "50%");
  el.addEventListener("mousemove", move);
}

// Рендер картинки с “темнотой + фонариком”
function renderFlashlightImage(containerId, src) {
  return `
    <div id="${containerId}" style="position:relative; max-width:1100px; margin:14px auto 0;">
      <img src="${escapeHtml(src)}"
           style="width:100%; height:auto; border-radius:16px; display:block;
                  border:1px solid rgba(255,255,255,0.12);
                  box-shadow:0 0 28px rgba(0,0,0,0.55);">
      <div class="flashlight-overlay"></div>
    </div>
  `;
}
function submitVitaForm() {
  const hair = document.getElementById("vitaHair")?.value || "";
  const age = document.getElementById("vitaAge")?.value || "";
  const clothes = document.getElementById("vitaClothes")?.value || "";
  const jewelry = document.getElementById("vitaJewelry")?.value || "";
  const notes = document.getElementById("vitaNotes")?.value || "";

  VITA_FORM.hair = hair;
  VITA_FORM.age = age;
  VITA_FORM.clothes = clothes;
  VITA_FORM.jewelry = jewelry;
  VITA_FORM.notes = notes;

  evaluateVitaForm();

  // ===== ТЕБЕ В КОНСОЛЬ (видно только тебе) =====
  console.log("[VITA_FORM] ответы игроков:", {
    hair, age, clothes, jewelry, notes,
    score: VITA_FORM.score,
    matched: VITA_FORM.matched
  });

  // Скрытая “панель автора” (по желанию)
  const authorPanel = `
    <details style="margin-top:14px; opacity:0.95;">
      <summary style="cursor:pointer;">Панель автора (только для тебя)</summary>
      <div style="margin-top:10px; padding:12px; border-radius:12px;
        background: rgba(0,0,0,0.28); border:1px solid rgba(255,255,255,0.12);">
        <p style="margin:0 0 8px 0;"><strong>Score:</strong> ${VITA_FORM.score}</p>
        <p style="margin:0 0 8px 0;"><strong>Matched:</strong></p>
        ${
          VITA_FORM.matched.length
            ? `<ul style="margin:0 0 10px 18px;">${VITA_FORM.matched.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
            : `<p style="margin:0 0 10px 0; opacity:0.85;">Совпадений мало.</p>`
        }
        <p style="margin:0; opacity:0.85;">
          <strong>Ввод:</strong><br>
          Волосы: ${escapeHtml(hair || "—")}<br>
          Возраст: ${escapeHtml(age || "—")}<br>
          Одежда: ${escapeHtml(clothes || "—")}<br>
          Украшения: ${escapeHtml(jewelry || "—")}<br>
          Детали: ${escapeHtml(notes || "—")}
        </p>
      </div>
    </details>
  `;

  // ===== Игрокам показываем только “реакцию” =====
  // Реакция зависит от score (но они не видят цифры)
  let reactionTitle = "Дежурная часть";
  let reactionText = "";
  let reactionHint = "";

  if (VITA_FORM.score >= 4) {
    reactionText = "Дежурный резко меняется в лице и уже смотрит внимательнее.";
    reactionHint = "«Есть одна, которая подходит под описание. Пойдёмте. Без крика — тихо.»";
  } else if (VITA_FORM.score >= 2) {
    reactionText = "Дежурный кивает, но видно — сомневается.";
    reactionHint = "«Похоже, есть похожая… но описание расплывчатое. Я попробую проверить по журналу.»";
  } else {
    reactionText = "Дежурный хмурится и стучит ручкой по столу.";
    reactionHint = "«С таким описанием я вам никого не найду. Вспоминайте точнее: волосы, одежда, возраст…»";
  }

  game.innerHTML = `
    <h2>${reactionTitle}</h2>

    <div style="margin-top:12px; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>${escapeHtml(reactionText)}</strong></p>
      <p style="margin-top:10px;">${escapeHtml(reactionHint)}</p>

      <p style="margin-top:12px; opacity:0.9;">
        Он снова смотрит в монитор и что-то быстро вбивает в систему.
      </p>
    </div>

    ${DETECTIVE_HONEST_MODE ? authorPanel : ""}

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button onclick="alert('Следующий шаг: вести к девушке / журнал / кабинет — добавим дальше')">Продолжить</button>
      <button onclick="startInterrogation()" style="opacity:0.85;">Изменить ответы</button>
    </div>
  `;
}

// ==================== ЭТАП: ДЕЖУРНАЯ ЧАСТЬ — ОПИСАНИЕ ВИТЫ (скрытая проверка) ====================

const DETECTIVE_HONEST_MODE = true; // true = игроки не видят совпадения (только реакцию)
                                     // админ-подсказки включаются через localStorage ADMIN_MODE

// Админ-режим (видно только тебе):
// localStorage.setItem("ADMIN_MODE","1")
// localStorage.removeItem("ADMIN_MODE")
function isAdminMode() {
  return localStorage.getItem("ADMIN_MODE") === "1";
}

function normText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/ё/g, "е")
    .replace(/[^\p{L}\p{N}\s-]+/gu, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function containsAny(text, keywords) {
  const t = normText(text);
  return keywords.some(k => t.includes(normText(k)));
}

// Ожидаемые признаки Виты (под твои фото / описание)
const VITA_PROFILE = {
  hair: {
    title: "Волосы",
    keywords: [
      "темные", "тёмные", "каштановые", "шатенка", "брюнетка", "темно-каштановые",
      "с челкой", "с чёлкой", "челка", "чёлка",
      "до плеч", "средняя длина", "каре", "волнистые"
    ]
  },
  age: {
    title: "Возраст",
    keywords: ["20", "21", "22", "23", "24", "25", "26","27", "примерно 23", "около 27","около 25", "около 23", "до 30"]
  },
  clothes: {
    title: "Одежда",
    keywords: [
      "черный пиджак", "чёрный пиджак", "пиджак", "жакет", "черный жакет", "чёрный жакет",
      "темная одежда", "черное платье", "черная майка", "черный топ", "чёрный топ",
      "сатиновый топ", "черная блузка", "чёрная блузка","чёрный костюм", "черный костюм","костюм"
    ]
  },
  accessories: {
    title: "Украшения / приметы",
    keywords: [
      "серьги", "сережки", "серёжки", "маленькие серьги", "подвески",
      "блестки на лице", "блёстки на лице", "глиттер", "блестящие точки",
      "веснушки"
    ]
  }
};

function officerReaction(score) {
  if (score >= 3) return "Дежурный чуть меняется в лице. Похоже, вы описываете кого-то очень конкретного.";
  if (score === 2) return "Дежурный кивает, но смотрит настороженно: «Похоже… но мне нужно точнее.»";
  if (score === 1) return "Дежурный не спешит: «Пока похоже на половину города. Давайте конкретнее.»";
  return "Дежурный хмурится: «Это слишком размыто. Я так никого не найду.»";
}

// Вход в дежурку (из правильной двери)
function startInterrogation() {
  const admin = isAdminMode();

  game.innerHTML = `
    <h2>Дежурная часть</h2>

    <div style="max-width:820px; margin:0 auto;">

      <div style="padding:16px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);">

        <p><strong>Дежурный</strong> поднимает глаза от журнала.</p>
        <p><strong>Дежурный:</strong> «По выходным ночью привозят от трёх до семи человек.»</p>
        <p><strong>Дежурный:</strong> «Фамилия? Имя?»</p>
        <p>Вы называете. Он проверяет по базе — и качает головой.</p>
        <p style="opacity:0.9;">
          «По документам такой нет. Но есть несколько девушек без точных данных.
          Нужны приметы. Опишите её точно.»
        </p>
      </div>

      <h3 style="margin-top:18px;">Опишите Виту (по памяти)</h3>

      <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">1) Волосы (цвет, длина, чёлка)</div>
          <input id="vitaHair" type="text"
            style="width:100%; padding:12px; border-radius:10px;
                   border:1px solid rgba(255,255,255,0.14);
                   background: rgba(0,0,0,0.25); color:#fff;">
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">2) Возраст</div>
          <input id="vitaAge" type="text"
            style="width:100%; padding:12px; border-radius:10px;
                   border:1px solid rgba(255,255,255,0.14);
                   background: rgba(0,0,0,0.25); color:#fff;">
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">3) Одежда</div>
          <input id="vitaClothes" type="text"
            style="width:100%; padding:12px; border-radius:10px;
                   border:1px solid rgba(255,255,255,0.14);
                   background: rgba(0,0,0,0.25); color:#fff;">
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">4) Украшения / приметы</div>
          <input id="vitaAcc" type="text"
            style="width:100%; padding:12px; border-radius:10px;
                   border:1px solid rgba(255,255,255,0.14);
                   background: rgba(0,0,0,0.25); color:#fff;">
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
          <button onclick="submitVitaDescription()">Сказать дежурному</button>
          <button onclick="policeCorridor2()" style="opacity:0.85;">Назад</button>
        </div>

        ${admin ? `
          <div style="margin-top:10px; padding:10px 12px; border-radius:12px;
            background: rgba(255,180,0,0.10);
            border:1px solid rgba(255,180,0,0.22);">
            Админ-режим включён (подсказки будут в консоли)
          </div>
        ` : ``}

      </div>
    </div>
  `;
}

function submitVitaDescription() {
  const hair = document.getElementById("vitaHair")?.value || "";
  const age  = document.getElementById("vitaAge")?.value || "";
  const cl   = document.getElementById("vitaClothes")?.value || "";
  const acc  = document.getElementById("vitaAcc")?.value || "";

  let score = 0;
  const matches = [];

  if (containsAny(hair, VITA_PROFILE.hair.keywords)) { score++; matches.push("волосы"); }
  if (containsAny(age,  VITA_PROFILE.age.keywords))  { score++; matches.push("возраст"); }
  if (containsAny(cl,   VITA_PROFILE.clothes.keywords)) { score++; matches.push("одежда"); }
  if (containsAny(acc,  VITA_PROFILE.accessories.keywords)) { score++; matches.push("приметы"); }

  if (isAdminMode()) {
    console.log("[VITA CHECK]", { hair, age, cl, acc, score, matches });
  }

  const reaction = officerReaction(score);

  // Показывать ли кнопку "Дальше"
  const allowNext = score >= 3;   // ← можешь поставить 3, если хочешь строже

  game.innerHTML = `
    <h2>Дежурная часть</h2>

    <div style="max-width:820px; margin:0 auto;
      padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p><strong>Вы</strong> описываете Виту по памяти.</p>
      <p style="margin-top:10px;"><strong>Дежурный</strong> слушает внимательно.</p>

      <p style="margin-top:10px;"><strong>Дежурный:</strong> «Понял.»</p>

      <p style="opacity:0.9;">${reaction}</p>

      <p style="margin-top:10px; opacity:0.9;">
        Он что-то отмечает в журнале и снова смотрит в монитор.
      </p>
    </div>

    ${isAdminMode() ? `
      <div style="max-width:820px; margin:12px auto 0 auto;
        padding:12px 14px; border-radius:14px;
        background: rgba(255,180,0,0.10);
        border:1px solid rgba(255,180,0,0.22);">
        <strong>Админ:</strong> score = ${score}/4 (${matches.join(", ") || "нет"})
      </div>
    ` : ``}

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      ${allowNext ? `<button type="button" onclick="startOfficerQuestionnaire()">Дальше</button>` : ``}
      <button onclick="startInterrogation()" style="opacity:0.85;">
        ${allowNext ? "Изменить ответы" : "Попробовать ещё раз"}
      </button>
    </div>
  `;
}

// Следующий шаг (заглушка)
function goToNextPoliceMiniGame() {
  game.innerHTML = `
    <h2>Дежурный поднимается</h2>
    <p style="opacity:0.9;">
      «Есть совпадение, можно проверить. Но вам придется сначала ответить на несколько вопросов...»
    </p>
    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="startOfficerQuestionnaire()">Продолжить</button>
      <button type="button" onclick="startInterrogation()" style="opacity:0.85;">Вернуться к описанию</button>
    </div>
  `;
}
// ==================== GOOGLE SHEETS WEB APP ====================
// Вставь сюда URL из Web App (заканчивается на /exec)
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxYqLsK9q6zV48TXx7j_NgsD9UU7pu_kptGiXl84pb0E7p3OJR1eGZ6r_zKyjLlgTVnxA/exec";

// Уникальная сессия (чтобы отличать разных игроков)
const SESSION_ID = (() => {
  const key = "DETECTIVE_SESSION_ID";
  let v = localStorage.getItem(key);
  if (!v) {
    v = "sess_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    localStorage.setItem(key, v);
  }
  return v;
})();

async function postToSheets(payload) {
  if (!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.includes("PASTE_YOUR_WEBAPP_URL_HERE")) {
    throw new Error("SHEETS_WEBAPP_URL не задан. Вставь URL Web App (/exec).");
  }

  const res = await fetch(SHEETS_WEBAPP_URL, {
    method: "POST",
    mode: "no-cors", // важно для простого хостинга без CORS
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // При mode:no-cors мы не можем читать ответ (это нормально)
  return true;
}

// ==================== ОПРОС ДЕЖУРНОГО (5 минут + отправка) ====================

const OFFICER_Q = {
  startedAt: 0,
  timerId: null,
  timerDone: false,
  sent: false,
  lastSentOk: false,
  lastError: ""
};

function startOfficerQuestionnaire() {
  OFFICER_Q.startedAt = Date.now();
  OFFICER_Q.timerDone = false;
  OFFICER_Q.sent = false;
  OFFICER_Q.lastSentOk = false;
  OFFICER_Q.lastError = "";

  if (OFFICER_Q.timerId) {
    clearInterval(OFFICER_Q.timerId);
    OFFICER_Q.timerId = null;
  }

  OFFICER_Q.timerId = setInterval(() => {
    const left = getOfficerTimeLeftMs();
    if (left <= 0) {
      OFFICER_Q.timerDone = true;
      clearInterval(OFFICER_Q.timerId);
      OFFICER_Q.timerId = null;
      renderOfficerQuestionnaire();
      return;
    }
    // обновляем только таймер
    const el = document.getElementById("officerTimer");
    if (el) el.textContent = formatMs(left);
  }, 250);

  renderOfficerQuestionnaire();

}

function getOfficerTimeLeftMs() {
  const DURATION = 3 * 60 * 1000; // 3 минутЫ
  const passed = Date.now() - OFFICER_Q.startedAt;
  return Math.max(0, DURATION - passed);

}

function formatMs(ms) {
  const s = Math.ceil(ms / 1000);
  const mm = String(Math.floor(s / 60)).padStart(2, "0");
  const ss = String(s % 60).padStart(2, "0");
  return `${mm}:${ss}`;

}
function ensureOfficerDraft() {
  if (!OFFICER_Q.draft) {
    OFFICER_Q.draft = { q1: "", q2: "", q3: "", q4: "" };
  }
}

function saveOfficerDraftFromDOM() {
  ensureOfficerDraft();

  OFFICER_Q.draft.q1 = document.getElementById("oq1")?.value || OFFICER_Q.draft.q1 || "";
  OFFICER_Q.draft.q2 = document.getElementById("oq2")?.value || OFFICER_Q.draft.q2 || "";
  OFFICER_Q.draft.q3 = document.getElementById("oq3")?.value || OFFICER_Q.draft.q3 || "";
  OFFICER_Q.draft.q4 = document.getElementById("oq4")?.value || OFFICER_Q.draft.q4 || "";
}

function restoreOfficerDraftToDOM() {
  ensureOfficerDraft();

  const oq1 = document.getElementById("oq1");
  const oq2 = document.getElementById("oq2");
  const oq3 = document.getElementById("oq3");
  const oq4 = document.getElementById("oq4");

  if (oq1) oq1.value = OFFICER_Q.draft.q1 || "";
  if (oq2) oq2.value = OFFICER_Q.draft.q2 || "";
  if (oq3) oq3.value = OFFICER_Q.draft.q3 || "";
  if (oq4) oq4.value = OFFICER_Q.draft.q4 || "";
}

function bindOfficerDraftAutosave() {
  ["oq1", "oq2", "oq3", "oq4"].forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;

    // чтобы не навешивать повторно
    if (el.dataset.draftBound === "1") return;
    el.dataset.draftBound = "1";

    el.addEventListener("input", saveOfficerDraftFromDOM);
  });
}

function clearOfficerDraft() {
  OFFICER_Q.draft = { q1: "", q2: "", q3: "", q4: "" };
}
function ensureOfficerDraft() {
  if (!OFFICER_Q.draft) {
    OFFICER_Q.draft = { q1: "", q2: "", q3: "", q4: "" };
  }
}

function saveOfficerDraftFromDOM() {
  ensureOfficerDraft();

  OFFICER_Q.draft.q1 = document.getElementById("oq1")?.value || OFFICER_Q.draft.q1 || "";
  OFFICER_Q.draft.q2 = document.getElementById("oq2")?.value || OFFICER_Q.draft.q2 || "";
  OFFICER_Q.draft.q3 = document.getElementById("oq3")?.value || OFFICER_Q.draft.q3 || "";
  OFFICER_Q.draft.q4 = document.getElementById("oq4")?.value || OFFICER_Q.draft.q4 || "";
}

function restoreOfficerDraftToDOM() {
  ensureOfficerDraft();

  const oq1 = document.getElementById("oq1");
  const oq2 = document.getElementById("oq2");
  const oq3 = document.getElementById("oq3");
  const oq4 = document.getElementById("oq4");

  if (oq1) oq1.value = OFFICER_Q.draft.q1 || "";
  if (oq2) oq2.value = OFFICER_Q.draft.q2 || "";
  if (oq3) oq3.value = OFFICER_Q.draft.q3 || "";
  if (oq4) oq4.value = OFFICER_Q.draft.q4 || "";
}

function bindOfficerDraftAutosave() {
  ["oq1", "oq2", "oq3", "oq4"].forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;

    // чтобы не навешивать повторно
    if (el.dataset.draftBound === "1") return;
    el.dataset.draftBound = "1";

    el.addEventListener("input", saveOfficerDraftFromDOM);
  });
}

function clearOfficerDraft() {
  OFFICER_Q.draft = { q1: "", q2: "", q3: "", q4: "" };
}

function renderOfficerQuestionnaire() {
 saveOfficerDraftFromDOM();
 const leftMs = getOfficerTimeLeftMs();
  const canProceed = OFFICER_Q.timerDone && OFFICER_Q.sent;

  const statusBox = OFFICER_Q.lastError
    ? `
      <div style="margin-top:12px; padding:12px 14px; border-radius:12px;
        background: rgba(255,120,120,0.10); border:1px solid rgba(255,120,120,0.22);">
        ${escapeHtml(OFFICER_Q.lastError)}
      </div>
    `
    : OFFICER_Q.lastSentOk
      ? `
        <div style="margin-top:12px; padding:12px 14px; border-radius:12px;
          background: rgba(120,255,120,0.10); border:1px solid rgba(120,255,120,0.20);">
          Ответы отправлены.
        </div>
      `
      : "";

  game.innerHTML = `
    <h2>Дежурная часть</h2>

    <div style="max-width:900px; margin:0 auto;">
      <div style="padding:16px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);">

        <p><strong>Дежурный</strong> опирается локтем на стол, не отводя взгляда.</p>
        <p><strong>Дежурный:</strong> «Ну расскажите, девочки…»</p>
        <p style="opacity:0.9;">
          «Что вы делали ночью? Где были? Куда уехали? Под чем были? Так боялись, что оставили подругу?»
        </p>

        <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="padding:8px 12px; border-radius:12px;
            background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.12);">
            <strong>Ожидание:</strong> <span id="officerTimer">${formatMs(leftMs)}</span>
            <div style="opacity:0.75; margin-top:4px; font-size:14px;">
              “Дальше” откроется только когда пройдёт таймер и ответы будут отправлены.
            </div>
  
          </div>

        ${statusBox}
      </div>

      <div style="margin-top:16px; display:flex; flex-direction:column; gap:12px;">
        <label>
          <div style="opacity:0.85; margin-bottom:6px;">1) Что за повод такой, так развлекаться ночью? </div>
          <textarea id="oq1" rows="2"
            style="width:90%; padding:12px; border-radius:12px; resize: none;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;"></textarea>
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">2) На каких локациях вы были?</div>
          <textarea id="oq2" rows="2"
            style="width:90%; padding:12px; border-radius:12px; resize: none;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;"></textarea>
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">3) Что делали? (кратко) </div>
          <textarea id="oq3" rows="2"
            style="width:90%; padding:12px; border-radius:12px; resize: none;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;"></textarea>
        </label>

        <label>
          <div style="opacity:0.85; margin-bottom:6px;">4) Когда вы поняли, что Вита пропала и почему оставили ее?</div>
          <textarea id="oq4" rows="2"
            style="width:90%; padding:12px; border-radius:12px; resize: none;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;"></textarea>
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:6px;">
          <button onclick="submitOfficerQuestionnaire()">Отправить ответы</button>

          ${canProceed ? `
            <button onclick="afterOfficerQuestionnaire()">Дальше</button>
          ` : `
            <button disabled style="opacity:0.45; cursor:not-allowed;">Дальше</button>
          `}

         </div>
    </div>
`;

restoreOfficerDraftToDOM();
bindOfficerDraftAutosave();
}

async function submitOfficerQuestionnaire() {
saveOfficerDraftFromDOM();
  const q1 = (document.getElementById("oq1")?.value || "").trim();
  const q2 = (document.getElementById("oq2")?.value || "").trim();
  const q3 = (document.getElementById("oq3")?.value || "").trim();
  const q4 = (document.getElementById("oq4")?.value || "").trim();

  // Не даём “просто ждать”: просим хотя бы что-то написать
  if (!q1 || !q2 || !q3 || !q4) {
    OFFICER_Q.lastError = "Заполните все ответы. Иначе я не могу это зафиксировать.";
    OFFICER_Q.lastSentOk = false;
    renderOfficerQuestionnaire();
    return;
  }
OFFICER_Q.lastError = "";
  OFFICER_Q.lastSentOk = false;

  const payload = {
    type: "OFFICER_QUESTIONNAIRE",
    page: "police_officer_questionnaire",
    userAgent: navigator.userAgent,
    sessionId: SESSION_ID,
    answers: { q1, q2, q3, q4 }
  };

  try {
    await postToSheets(payload);
    OFFICER_Q.sent = true;
    OFFICER_Q.lastSentOk = true;
    OFFICER_Q.lastError = "";
  } catch (err) {
    OFFICER_Q.lastError = "Не удалось отправить ответы. Проверь URL Web App и доступ.";
    OFFICER_Q.lastSentOk = false;
  }

  renderOfficerQuestionnaire();
}

function afterOfficerQuestionnaire() {
clearOfficerDraft();
  game.innerHTML = `
    <h2>Дежурная часть</h2>
    <div style="max-width:900px; margin:0 auto; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p><strong>Дежурный</strong> молча читает ваши ответы.</p>
      <p style="margin-top:10px; opacity:0.9;">
        «Ясно…» — говорит он наконец и кладёт ручку.
      </p>
      <p style="opacity:0.9;">
        «Дальше — по моим правилам. Тихо. Без спектаклей.»
      </p>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button type="button" onclick="goToVitaHappyEnd()">Идти к Вите</button>
    </div>
  `;
}

// ===== ХЭППИ-ЭНД (страница с диалогом) =====
function goToVitaHappyEnd() {
  game.innerHTML = `
    <h2>Коридор</h2>

    <div style="max-width:900px; margin:0 auto; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);">

      <p style="opacity:0.9;">Дежурный ведёт вас по коридору, не оглядываясь.</p>
      <p style="margin-top:10px;">
        Свет здесь холодный, и от этого кажется, что время остановилось.
      </p>

      <p style="margin-top:10px; opacity:0.95;">
        У двери он коротко кивает:
        <strong>«Только спокойно.»</strong>
      </p>

      <p style="margin-top:12px;">
        Вы видите девушку. Да, это Вита!
      </p>

      <p style="margin-top:10px; opacity:0.95;">
        <strong>Вита</strong> сидит на стуле. Уставшая, грустная, видно, что плакала.
        Она поднимает глаза… и в них сначала злость, но потом облегчение.
      </p>

      <p style="margin-top:10px;">
        <strong>Вита:</strong> «Боже, наконец-то вы пришли..»
      </p>
      <p>
        <strong>Катя</strong> делает шаг вперёд и будто только сейчас понимает, насколько страшно могло всё закончиться.
      </p>
      <p>
        <strong>Катя:</strong> «Прости. Мы думали ты впереди где-то бежишь в ту же сторону… мы…»
      </p>
<p>
        <strong>Алена:</strong> «Мы даже подумать не могли, что тебя схватили! мы ехали в такси и срочно пытались придумать, что и куда ехать дальше и только уже в Гатчина осознали, что тебя нет! А телефоны сели и было так страшно.»
      </p>
<p>
        <strong>Настя:</strong> «Да, мы просто пьяные дуры!»
      </p>
<p>
        <strong>Лена:</strong> «Мы очень виноваты перед тобой, прости нас пожалуйста..»
      </p>
      <p style="margin-top:10px; opacity:0.9;">
        Вита смотрит долго — как будто решает, злиться или просто отпустить.
        И вместо упрёка она тихо выдыхает:
      </p>

      <p style="margin-top:8px;">
        <strong>Вита:</strong> «Я очень испугалась, когда меня одну схватили. Но… я рада, что вы пришли.»
      </p>
       
<p style="margin-top:12px; opacity:0.9;">

Девочки бросаются обнимать Виту и уже не могут сдержать слёз. Они наперебой просят прощения, жалеют, что всё так вышло, и признаются, как сильно испугались за неё.

Вита сначала держится напряжённо, но потом тоже обнимает их в ответ. Становится легче — всем сразу.

Они ещё немного стоят вместе, вытирая слёзы и приходя в себя. Теперь ясно: самое страшное позади.

Девочки уходят вместе — уставшие, заплаканные, но уже спокойные.
</p>
<p style="margin-top:12px; opacity:0.9;">
Вот так девушки неожиданно отпраздновали девичник. Да, их поступки были глупыми и опрометчивыми, и эту ночь точно нельзя назвать идеальной. Но важнее всего то, что они вынесли из неё не только страх и ошибки, а ещё важный опыт, сильные эмоции и воспоминания, которые останутся с ними надолго — в отличие от похмелья.
</p>
<!-- БОЛЬШАЯ КАРТИНКА ПОД ТЕКСТОМ -->
      <div style="margin-top:18px; text-align:center;">
        <img
          src="vita_happy_end.png"
          alt="Счастливый финал: девушки обнимают Виту"
          style="
            width:100%;
            max-width:860px;
            height:auto;
            border-radius:14px;
            display:block;
            margin:0 auto;
            border:1px solid rgba(255,255,255,0.14);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
          "
        >
      </div>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <button type="button" onclick="resetNotebookNotesSilently(); openFeedbackForm()">Оставить отзыв / пожелания</button>
<button type="button" onclick="resetNotebookNotesSilently(); showFinalThanks()">Завершить</button>
    </div>
  `;
}

function showFinalThanks() {
  game.innerHTML = `
    <h2>Конец</h2>
    <div style="max-width:900px; margin:0 auto; padding:16px; border-radius:14px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      <p style="opacity:0.95;">
        История заканчивается тихо — без громких слов.
        Но теперь главное известно: Вита нашлась.
      </p>
      <p style="opacity:0.85;">
        Спасибо, что прошли игру! С удовольствием прочтем ваши отзывы об игре и пожелания. До скорых встреч!
      </p>
    </div>

    <div style="margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="openFeedbackForm()">Оставить отзыв</button>
    </div>
  `;
}

// ===== ОТЗЫВ + отправка в ТУ ЖЕ таблицу =====
function openFeedbackForm() {
  game.innerHTML = `
    <h2>Отзыв</h2>

    <div style="max-width:900px; margin:0 auto;">
      <div style="padding:16px; border-radius:14px;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.12);">

        <p style="opacity:0.9;">
          Напиши, что понравилось, что было непонятно, и что ты бы добавил(а) в игру.
        </p>

        <label style="display:block; margin-top:12px;">
          <div style="opacity:0.85; margin-bottom:6px;">Оценка (1–10)</div>
          <input id="fbScore" type="number" min="1" max="10"
            style="width:140px; padding:10px; border-radius:10px;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;">
        </label>

        <label style="display:block; margin-top:12px;">
          <div style="opacity:0.85; margin-bottom:6px;">Текст отзыва</div>
          <textarea id="fbText" rows="5"
            style="width:100%; padding:12px; border-radius:12px; resize: none;
              border:1px solid rgba(255,255,255,0.14);
              background: rgba(0,0,0,0.25); color:#fff;"></textarea>
        </label>

        <div id="fbStatus" style="margin-top:12px;"></div>

        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
          <button type="button" onclick="submitFeedback()">Отправить отзыв</button>
          <button type="button" onclick="goToVitaHappyEnd()" style="opacity:0.85;">Назад</button>
        </div>
      </div>
    </div>
  `;
}

async function submitFeedback() {
  const score = (document.getElementById("fbScore")?.value || "").trim();
  const text  = (document.getElementById("fbText")?.value || "").trim();
  const box   = document.getElementById("fbStatus");

  if (!text) {
    if (box) box.innerHTML = `
      <div style="padding:10px 12px; border-radius:12px;
        background: rgba(255,120,120,0.10); border:1px solid rgba(255,120,120,0.22);">
        Напиши хоть пару слов — иначе нечего отправлять 🙂
      </div>`;
    return;
  }

  if (box) box.innerHTML = `
    <div style="padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);">
      Отправляю…
    </div>`;

  const payload = {
    type: "FEEDBACK",
    page: "feedback",
    userAgent: navigator.userAgent,
    sessionId: SESSION_ID,
    rating: score || "",
    feedback: text
  };

  try {
    await postToSheets(payload);
    if (box) box.innerHTML = `
      <div style="padding:10px 12px; border-radius:12px;
        background: rgba(120,255,120,0.10); border:1px solid rgba(120,255,120,0.20);">
        Спасибо! Отзыв отправлен.
      </div>`;
  } catch (e) {
    if (box) box.innerHTML = `
      <div style="padding:10px 12px; border-radius:12px;
        background: rgba(255,120,120,0.10); border:1px solid rgba(255,120,120,0.22);">
        Не получилось отправить. Проверь Web App URL и доступ.
      </div>`;
  }
}
function setGameBackground(imagePath) {
  document.documentElement.style.setProperty('--bg-image', `url("${imagePath}")`);
}
// ===== ГЛОБАЛЬНЫЙ БЛОКНОТ ДЛЯ ЗАПИСЕЙ =====
const NOTEBOOK = {
  storageKey: "detective_notebook_notes_v1",
  isOpen: false
};

function initNotebookWidget() {
  // защита от повторного создания
  if (document.getElementById("notebookWidget")) return;

  // Кнопка открытия
  const toggleBtn = document.createElement("button");
  toggleBtn.id = "notebookToggleBtn";
  toggleBtn.type = "button";
  toggleBtn.textContent = "Блокнот для записей";
  toggleBtn.onclick = toggleNotebook;

  // Виджет
  const widget = document.createElement("div");
  widget.id = "notebookWidget";

  widget.innerHTML = `
    <div id="notebookPanel">
      <div class="notebook-header">
        <div class="notebook-title">Блокнот</div>
        <div class="notebook-actions">
          <button type="button" class="notebook-mini-btn" onclick="clearNotebookNotes()">Очистить</button>
          <button type="button" class="notebook-mini-btn" onclick="toggleNotebook(false)">Закрыть</button>
        </div>
      </div>

      <div class="notebook-paper">
        <div class="notebook-inner">
          <textarea
            id="notebookText"
            placeholder="Записывайте здесь улики, подозрения, версии, время, маршруты, детали..."
          ></textarea>

          <div class="notebook-footer">
            <span id="notebookStatus">Сохранено</span>
            <span id="notebookCount">0 символов</span>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(widget);
  document.body.appendChild(toggleBtn);

  // Загрузка сохранённых заметок
  const textarea = document.getElementById("notebookText");
  const saved = loadNotebookNotes();
  textarea.value = saved;
  updateNotebookMeta();

  // Автосохранение
  let saveTimer = null;
  textarea.addEventListener("input", () => {
    setNotebookStatus("Сохранение...");
    updateNotebookMeta();

    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      saveNotebookNotes(textarea.value);
      setNotebookStatus("Сохранено");
    }, 250);
  });

  // Закрытие по Esc
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && NOTEBOOK.isOpen) {
      toggleNotebook(false);
    }
  });
}

function toggleNotebook(forceState) {
  const widget = document.getElementById("notebookWidget");
  const textarea = document.getElementById("notebookText");
  if (!widget) return;

  if (typeof forceState === "boolean") {
    NOTEBOOK.isOpen = forceState;
  } else {
    NOTEBOOK.isOpen = !NOTEBOOK.isOpen;
  }

  widget.classList.toggle("open", NOTEBOOK.isOpen);

  if (NOTEBOOK.isOpen && textarea) {
    setTimeout(() => textarea.focus(), 120);
  }
}

function saveNotebookNotes(text) {
  try {
    localStorage.setItem(NOTEBOOK.storageKey, text || "");
  } catch (e) {
    setNotebookStatus("Не удалось сохранить");
    console.warn("Notebook save error:", e);
  }
}

function loadNotebookNotes() {
  try {
    return localStorage.getItem(NOTEBOOK.storageKey) || "";
  } catch (e) {
    console.warn("Notebook load error:", e);
    return "";
  }
}

function clearNotebookNotes() {
  const textarea = document.getElementById("notebookText");
  if (!textarea) return;

  const ok = confirm("Очистить все записи в блокноте?");
  if (!ok) return;

  textarea.value = "";
  saveNotebookNotes("");
  updateNotebookMeta();
  setNotebookStatus("Очищено");
  textarea.focus();
}

function setNotebookStatus(text) {
  const el = document.getElementById("notebookStatus");
  if (el) el.textContent = text;
}

function updateNotebookMeta() {
  const textarea = document.getElementById("notebookText");
  const count = document.getElementById("notebookCount");
  if (!textarea || !count) return;

  count.textContent = `${textarea.value.length} символов`;
}
initNotebookWidget();
function resetNotebookNotesSilently() {
  try {
    // если у тебя localStorage (как сейчас)
    localStorage.removeItem(NOTEBOOK.storageKey);

    // если потом перейдёшь на sessionStorage — можешь добавить и это:
    // sessionStorage.removeItem(NOTEBOOK.storageKey);
  } catch (e) {
    console.warn("Notebook reset error:", e);
  }

  const textarea = document.getElementById("notebookText");
  if (textarea) {
    textarea.value = "";
  }

  updateNotebookMeta();
  setNotebookStatus("Очищено");
}
document.addEventListener("click", startBgMusicIfNeeded, { passive: true });
// -------------------- Запуск игры --------------------
showRulesScreen();

</script>

</body>
</html>



